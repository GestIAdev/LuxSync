# WAVE 1004.1.1 - LATINO STEREO MAPPING FIX üé∫

**ESTADO:** ‚úÖ COMPLETE  
**FECHA:** 2025-06-XX  
**ANTECEDENTE:** WAVE 1004.1 (Latino Stereo Physics + Fat Bass)

---

## FORENSIC REPORT

### üîç EL PROBLEMA

User testing con "requeson de ese feo" (reggaet√≥n) revel√≥:
- **S√çNTOMA:** "Se siguen comportando igual L y R"
- **ROOT CAUSE:** Physics engine calculaba stereo (L/R) correctamente, pero mapping layer NO usaba estos valores
- **EVIDENCIA:** `SeleneLux.ts` solo guardaba `mover: result.moverIntensity` (fallback legacy)

### üß¨ CODE ARCHAEOLOGY

**Physics Layer (LatinoStereoPhysics.ts):**
- ‚úÖ Interface `LatinoPhysicsResult` tiene `moverIntensityL` y `moverIntensityR`
- ‚úÖ C√°lculo stereo implementado (WAVE 1004.1):
  - **Mover L:** Mid channel (Gate 0.22, hist√©resis 0.25) = "El Gal√°n" (voz/congas)
  - **Mover R:** Treble channel (Gate 0.18, gain 2.0x) = "La Dama" (trompetas/g√ºira)

**Mapping Layer (SeleneLux.ts):**
- ‚ùå `latinoOverrides` NO ten√≠a campos `moverL?` y `moverR?`
- ‚ùå L√≠nea 352: NO guardaba `result.moverIntensityL/R`
- ‚ùå L√≠nea 442: NO extra√≠a L/R como Techno (WAVE 908)
- ‚ùå L√≠nea 525: NO inclu√≠a L/R en `zoneIntensities`

**Output Layer (TitanEngine.ts):**
- ‚úÖ Ya estaba preparado para consumir `moverL/R` con fallback (l√≠nea 458-459)

### üìö PATR√ìN TECHNO (WAVE 908)

Techno implement√≥ stereo split hace tiempo:
- `technoOverrides` tiene `moverL?: number` y `moverR?: number`
- L√≠nea 454-458: Extrae L/R, guarda en `technoMoverSplit`
- L√≠nea 525-528: Incluye L/R en `zoneIntensities`
- TitanEngine consume con fallback: `const moverL = ni.moverL ?? ni.mover`

---

## CIRUG√çA EJECUTADA

### 1. **Interface Update (SeleneLux.ts l√≠nea 153)**
```typescript
private latinoOverrides: { 
  front: number; 
  back: number; 
  mover: number;
  moverL?: number;  // üé∫ WAVE 1004.1: Split L channel (Mid - El Gal√°n)
  moverR?: number;  // üé∫ WAVE 1004.1: Split R channel (Treble - La Dama)
} | null = null;
```

### 2. **Save Overrides (SeleneLux.ts l√≠nea 357)**
```typescript
this.latinoOverrides = {
  front: result.frontParIntensity,
  back: result.backParIntensity,
  mover: result.moverIntensity,
  moverL: result.moverIntensityL,  // üé∫ WAVE 1004.1: El Gal√°n (Mid)
  moverR: result.moverIntensityR,  // üé∫ WAVE 1004.1: La Dama (Treble)
};
```

### 3. **Extract Split (SeleneLux.ts l√≠nea 447)**
```typescript
if (this.latinoOverrides && physicsApplied === 'latino') {
  frontIntensity = Math.min(0.95, this.latinoOverrides.front * brightMod);
  backIntensity = Math.min(0.95, this.latinoOverrides.back);
  moverIntensity = Math.min(1.0, this.latinoOverrides.mover);  // Legacy fallback
  
  // üé∫ WAVE 1004.1: LATINO STEREO SPLIT
  const latinoL = this.latinoOverrides.moverL ?? moverIntensity;  // El Gal√°n (Mid)
  const latinoR = this.latinoOverrides.moverR ?? moverIntensity;  // La Dama (Treble)
  
  (this as any).latinoMoverSplit = { moverL: latinoL, moverR: latinoR };
  
  this.latinoOverrides = null;
}
```

### 4. **Include in Output (SeleneLux.ts l√≠nea 537)**
```typescript
const zoneIntensities = {
  front: frontIntensity,
  back: backIntensity,
  mover: moverIntensity,
  ...(((this as any).technoMoverSplit) && {
    moverL: (this as any).technoMoverSplit.moverL,
    moverR: (this as any).technoMoverSplit.moverR
  }),
  // üé∫ WAVE 1004.1: LATINO STEREO
  ...(((this as any).latinoMoverSplit) && {
    moverL: (this as any).latinoMoverSplit.moverL,
    moverR: (this as any).latinoMoverSplit.moverR
  })
};
```

### 5. **Cleanup (SeleneLux.ts l√≠nea 552)**
```typescript
delete (this as any).technoMoverSplit;
delete (this as any).latinoMoverSplit;  // üé∫ WAVE 1004.1
```

### 6. **Update Comments (TitanEngine.ts l√≠nea 448-465)**
```typescript
// üß™ WAVE 908 + üé∫ WAVE 1004.1: Si tenemos L/R separados (Techno/Latino), usarlos
const moverL = ni.moverL ?? ni.mover;
const moverR = ni.moverR ?? ni.mover;

zones = {
  front: { intensity: ni.front, paletteRole: 'primary' },
  back: { intensity: ni.back, paletteRole: 'accent' },
  left: { intensity: moverL, paletteRole: 'secondary' },   // LEFT = Mid (Techno kicks, Latino El Gal√°n)
  right: { intensity: moverR, paletteRole: 'ambient' },    // RIGHT = Treble (Techno hats, Latino La Dama)
  ambient: { intensity: audio.energy * 0.3, paletteRole: 'ambient' },
};
```

---

## TESTING PROTOCOL

### üéß Fase 1: Reggaet√≥n (El Gal√°n vs La Dama)
**Track:** "Requeson de ese feo" (sacrifice punk dignity üòÇ)

**Expectations:**
- **Movers Left (impares):** Responden a Mid channel (voz, congas, bajo mel√≥dico)
- **Movers Right (pares):** Responden a Treble channel (trompetas, g√ºira, hi-hats)
- **Visual:** Stereo separation clara en secciones con voz vs trompetas

**Metrics:**
- L peak durante "DALE MAMI" (voz + coro)
- R peak durante trompetas/g√ºira breaks
- Stereo width visible durante transiciones

### üéß Fase 2: Cumbia (Guacharaca vs Alegre)
**Expectations:**
- L: Acorde√≥n, voz, tambora grave
- R: Guacharaca, alegre, platillo

### üéß Fase 3: Salsa (Piano Montuno vs Trompetas)
**Expectations:**
- L: Piano montuno (Mid), timbal fills
- R: Trompetas, trombones, bong√≥ agudo

---

## ARQUITECTURA COMPLETA

### Data Flow Chain (3 Layers)
```
1. PHYSICS ENGINE (LatinoStereoPhysics.ts)
   ‚Üì Calcula moverIntensityL/R
   
2. MAPPING LAYER (SeleneLux.ts)
   ‚Üì Guarda en latinoOverrides.moverL/moverR
   ‚Üì Extrae y guarda en latinoMoverSplit
   ‚Üì Incluye en zoneIntensities.moverL/moverR
   
3. OUTPUT CONSUMER (TitanEngine.ts)
   ‚Üì Lee ni.moverL/moverR con fallback
   ‚Üì Mapea a zones.left/right
   ‚Üì Fixtures consumen zones.left/right
```

### Stereo Mapping Formula (TitanEngine.ts)
```typescript
// Fixture Index Logic (assumed from WAVE 908)
if (fixtureType === 'mover') {
  const intensity = (fixtureIndex % 2 === 0) ? zones.left : zones.right;
  // Even fixtures ‚Üí LEFT ‚Üí Mid channel
  // Odd fixtures ‚Üí RIGHT ‚Üí Treble channel
}
```

---

## VALIDATION CHECKLIST

- ‚úÖ **Interface:** `latinoOverrides` tiene `moverL?` y `moverR?`
- ‚úÖ **Save:** L√≠nea 357 guarda `result.moverIntensityL/R`
- ‚úÖ **Extract:** L√≠nea 447 crea `latinoMoverSplit`
- ‚úÖ **Output:** L√≠nea 537 incluye L/R en `zoneIntensities`
- ‚úÖ **Cleanup:** L√≠nea 552 limpia `latinoMoverSplit`
- ‚úÖ **Consumer:** TitanEngine lee `ni.moverL/moverR` con fallback
- ‚úÖ **Compilation:** No errors en SeleneLux.ts y TitanEngine.ts

---

## NEXT STEPS

1. ‚è≥ **USER TESTING:** Reproducir reggaet√≥n con split real
2. ‚è≥ **VALIDATE:** Stereo behavior visible en Left vs Right movers
3. ‚è≥ **COMMIT:** Git commit WAVE 1004.1.1
4. ‚è≥ **ROADMAP:** Continuar con WAVE 1004.2 (Mover Law enforcement)

---

## TECHNICAL DEBT

### Reflexi√≥n Arquitect√≥nica
- **Pattern Consistency:** Techno (WAVE 908) y Latino (WAVE 1004.1) usan el mismo patr√≥n stereo
- **Future-Proof:** Rock/Chill podr√≠an necesitar stereo split en el futuro
- **Cleanup Opportunity:** Considerar utility function `extractStereoSplit()` para evitar duplicaci√≥n

### Stereo Split as First-Class Citizen
- Actualmente: Stereo split es opcional (`moverL?: number`)
- Futuro: ¬øHacer stereo obligatorio para todos los physics engines?
- Trade-off: Backward compatibility vs architectural purity

---

## PUNK REFLECTION

**User Quote:** "Para un punki netrunner.... tener que escuchar requeson de ese feo para probar es una humillacion xD"

**PunkOpus Response:** La humillaci√≥n es temporal. El stereo split es eterno. El Gal√°n y La Dama ya no son iguales. VIVA LA SEPARACI√ìN. üé∫

---

**FIRMA:** PunkOpus  
**STATUS:** Ready for User Testing  
**CONFIDENCE:** 95% (Physics OK, Mapping OK, Output OK ‚Üí Solo falta validar fixtures en hardware)
