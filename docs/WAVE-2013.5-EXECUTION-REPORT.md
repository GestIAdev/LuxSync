# WAVE 2013.5: THE MATH FIX - EXECUTION REPORT

**Date**: February 9, 2026  
**Status**: ‚úÖ COMPLETED  
**Directive Origin**: PunkOpus Engineering ‚Üí Claude Opus (Core Logic & Interaction)  
**Objective**: Restringir crecimiento a Vibes + Arreglar matem√°ticas de Resize/Move

---

## üìã EXECUTIVE SUMMARY

**Problemas Resueltos**:
- ‚úÖ FX clips ya no crecen durante grabaci√≥n (solo Vibes)
- ‚úÖ Resize/Move ahora responde 1:1 con el movimiento del rat√≥n
- ‚úÖ No m√°s "salirse de pantalla" al mover un poco

**Root Cause del Bug de Resize**:
El c√≥digo original usaba `clip.startMs` o `clip.endMs` como base en CADA frame del mouse move, pero esos valores cambiaban cada vez que se actualizaba el clip. Esto causaba **acumulaci√≥n de error exponencial**.

---

## üîß FIX 1: VIBE-ONLY GROWTH

### Problema
Los FX clips tambi√©n crec√≠an durante la grabaci√≥n, cuando deber√≠an tener duraci√≥n fija.

### Soluci√≥n
A√±adido check expl√≠cito en `tickActiveClips()`:

```typescript
// WAVE 2013.5: Only update VIBE clips (trackId === 'vibe')
// FX clips have fixed duration and don't grow
if (this.state.activeVibeClipId) {
  const vibeClip = this.state.clips.find(c => c.id === this.state.activeVibeClipId)
  // Double-check: only grow if it's actually on the vibe track
  if (vibeClip && vibeClip.trackId === 'vibe') {
    const newDuration = this.state.playheadMs - vibeClip.startMs
    // ... update logic
  }
}
```

### Comportamiento Resultante
| Tipo | Durante Grabaci√≥n |
|------|------------------|
| Vibe | Crece en tiempo real (Living Clip) |
| FX | Aparece con duraci√≥n fija (defaultDurationMs) |

---

## üîß FIX 2: INTERACTION MATH REPAIR

### Problema Original
```typescript
// ‚ùå ANTES: Usaba el tiempo ACTUAL del clip como base
else if (resizingClip) {
  const clip = clips.find(c => c.id === resizingClip.id)
  if (clip) {
    const currentTime = resizingClip.edge === 'left' ? clip.startMs : clip.endMs
    // ‚ö†Ô∏è currentTime cambia cada frame porque clip se actualiza!
    const newTimeMs = currentTime + deltaMs
    // ‚ö†Ô∏è Esto causa drift: cada frame suma deltaMs al nuevo valor
  }
}
```

### Diagn√≥stico
- Frame 1: deltaMs = 100, clip.endMs = 1000, newEnd = 1100
- Frame 2: deltaMs = 100, clip.endMs = 1100 (ya actualizado!), newEnd = 1200
- Frame 3: deltaMs = 100, clip.endMs = 1200, newEnd = 1300
- **Resultado**: El clip crece 3x m√°s r√°pido de lo esperado

### F√≥rmula Correcta
```
deltaPixels = mouseX - startMouseX
deltaTimeMs = (deltaPixels / pixelsPerSecond) * 1000
newTimeMs = originalEdgeMs + deltaTimeMs  ‚Üê Siempre desde el ORIGINAL
```

### Soluci√≥n Implementada

#### 1. Actualizar el tipo del ref
```typescript
// WAVE 2013.5: A√±adido originalEdgeMs para guardar el tiempo original
const dragStartRef = useRef<{ 
  x: number; 
  startMs: number; 
  originalEdgeMs: number 
} | null>(null)
```

#### 2. Guardar tiempo original al inicio del drag
```typescript
const handleClipResizeStart = useCallback((clipId, edge, e) => {
  const clip = clips.find(c => c.id === clipId)
  if (!clip) return
  
  // WAVE 2013.5: Store the ORIGINAL edge time at drag start
  const originalEdgeMs = edge === 'left' ? clip.startMs : clip.endMs
  setResizingClip({ id: clipId, edge })
  dragStartRef.current = { x: e.clientX, startMs: clip.startMs, originalEdgeMs }
}, [clips])
```

#### 3. Calcular siempre desde el original
```typescript
const handleMouseMove = (e: MouseEvent) => {
  if (!dragStartRef.current) return
  
  // WAVE 2013.5: Correct delta calculation
  const deltaX = e.clientX - dragStartRef.current.x
  const deltaMs = (deltaX / viewport.pixelsPerSecond) * 1000
  
  if (draggingClipId) {
    // MOVE: Calculate from ORIGINAL startMs
    const newStartMs = Math.max(0, dragStartRef.current.startMs + deltaMs)
    onClipMove?.(draggingClipId, newStartMs)
  } else if (resizingClip) {
    // RESIZE: Calculate from ORIGINAL edge position
    const newTimeMs = Math.max(0, dragStartRef.current.originalEdgeMs + deltaMs)
    onClipResize?.(resizingClip.id, resizingClip.edge, newTimeMs)
  }
}
```

---

## üìê MATH BREAKDOWN

### Conversi√≥n P√≠xeles ‚Üí Tiempo

```
pixelsPerSecond = 100 (zoom level)

Si mueves 50 p√≠xeles a la derecha:
deltaX = 50 px
deltaMs = (50 / 100) * 1000 = 500 ms

Si mueves 200 p√≠xeles a la izquierda:
deltaX = -200 px
deltaMs = (-200 / 100) * 1000 = -2000 ms
```

### Boundaries

```typescript
// Nunca menor que 0
const newTimeMs = Math.max(0, originalEdgeMs + deltaMs)

// El hook useTimelineClips aplica m√°s validaciones:
const minDuration = 500 // No puede ser m√°s corto que 500ms
if (edge === 'left') {
  const maxStart = clip.endMs - minDuration
  const newStart = Math.min(snappedTime, maxStart)
}
```

---

## üìÅ ARCHIVOS MODIFICADOS

| Archivo | Cambios |
|---------|---------|
| `ChronosRecorder.ts` | A√±adido check `trackId === 'vibe'` en tickActiveClips() |
| `TimelineCanvas.tsx` | Corregida matem√°tica de drag: guardar originalEdgeMs, calcular desde original |
| `ChronosLayout.tsx` | Actualizado comentario de growingClipId |

---

## ‚úÖ TESTING SCENARIOS

### Test 1: Vibe Growth (debe funcionar)
```
1. ARM ‚Üí Recording
2. Click Vibe TECHNO
3. ‚úÖ Clip aparece y CRECE en tiempo real
4. ‚úÖ Pulso rojo en borde derecho
```

### Test 2: FX Fixed Duration (debe funcionar)
```
1. ARM ‚Üí Recording
2. Click FX "Industrial Strobe"
3. ‚úÖ Clip aparece con 2000ms (o defaultDuration)
4. ‚úÖ NO crece, NO tiene pulso rojo
5. ‚úÖ Bloque est√°tico en FX track
```

### Test 3: Resize Suave
```
1. Tener clip en timeline
2. Hover borde derecho ‚Üí cursor ew-resize
3. Drag 100px a la derecha
4. ‚úÖ Clip se alarga exactamente 1 segundo (si zoom = 100px/s)
5. ‚úÖ No hay "salto" o "escape"
```

### Test 4: Move Suave
```
1. Tener clip en timeline
2. Click y drag horizontalmente
3. ‚úÖ Clip sigue exactamente al cursor
4. ‚úÖ Snap a grid cuando suelta
```

### Test 5: Boundary Checks
```
1. Drag clip hacia la izquierda m√°s all√° de t=0
2. ‚úÖ Clip se detiene en t=0
3. Resize borde izquierdo m√°s all√° del borde derecho
4. ‚úÖ Clip mantiene minDuration de 500ms
```

---

## üî¨ BEFORE/AFTER

### Antes (WAVE 2013)
```
‚ùå FX clips crecen durante grabaci√≥n
‚ùå Resize causa drift exponencial
‚ùå Mover clip 10px = clip desaparece
```

### Despu√©s (WAVE 2013.5)
```
‚úÖ Solo Vibe clips crecen
‚úÖ Resize es 1:1 con movimiento de rat√≥n
‚úÖ Mover clip 10px = clip se mueve 100ms (si zoom = 100px/s)
```

---

## üí≠ PUNK NOTES

El bug era de esos que te vuelven loco.
Mueves el rat√≥n un poco y el clip desaparece en el infinito.

El problema: usar un valor que cambia como base para el siguiente c√°lculo.
Es como intentar medir tu altura mientras creces.

La soluci√≥n: **anclar al origen**.
Cuando empiezas a arrastrar, guardas el punto fijo.
Luego siempre calculas desde ah√≠.

Simple cuando lo ves.
Imposible de debugear cuando no lo ves.

Ahora los clips responden como mantequilla.
Eso es UX profesional.

---

**Signed**: PunkOpus  
**For**: Radwulf & Chronos Studio  
**Date**: 2026-02-09
