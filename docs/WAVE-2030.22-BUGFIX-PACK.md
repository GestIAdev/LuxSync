# WAVE 2030.22: BUGFIX PACK üîß
## Audio Persistence + Curve Editor NaN Fix

**Fecha**: 2026-02-12  
**Estado**: ‚úÖ COMPLETADO  
**Tipo**: HOTFIX

---

## FILOSOF√çA

> *"Los bugs son deuda t√©cnica. Se pagan al contado, no a plazos."*

Dos hotfixes cr√≠ticos: uno afectaba la experiencia de usuario (sesi√≥n que no cargaba audio), el otro afectaba la herramienta de autor (curvas de color no renderizaban). Ambos violaban el Axioma Perfection First.

---

## BUG 1: AUDIO PERSISTENCE FAILURE

### S√≠ntoma:
Al salir de Chronos y volver, el `SessionStore` ten√≠a `audioRealPath` pero el audio NO se cargaba porque el `fetch()` fallaba silenciosamente.

### Root Cause:
En `ChronosLayout.tsx` l√≠nea 286, se hac√≠a:
```typescript
fetch(`file:///${session.audioRealPath.replace(/\\/g, '/')}`)
```

**Problemas m√∫ltiples**:
1. `fetch()` con `file://` URLs tiene restricciones CORS en Electron renderer process
2. Incluso con normalizaci√≥n de path, el fetch falla por security policy
3. Intentar recrear un `File` object desde blob para luego llamar `loadFile()` es indirecto

### Fix (v2 - WAVE 2030.22b):
Cambiar de `fetch()` + `loadFile()` a usar directamente `loadFromPath()` que ya existe en `useAudioLoaderPhantom`:

```typescript
// ‚öíÔ∏è WAVE 2030.22b: Use loadFromPath() instead of fetch() to avoid CORS issues
audioLoader.loadFromPath(session.audioRealPath)
  .then((result) => {
    if (result) {
      console.log('[SessionKeeper] ‚úÖ Audio restored successfully')
      if (session.playheadMs > 0) {
        streaming.seek(session.playheadMs)
      }
    }
  })
```

### ¬øPor qu√© esto funciona?
- `loadFromPath()` llama a `chronos:analyze-audio` IPC con `filePath`
- El main process lee el archivo con `fs.readFile` (sin restricciones CORS)
- El analysis se hace en PhantomWorker
- Se devuelve el Blob URL para streaming (construido en main process)
- Zero fetch(), zero CORS issues

---

## BUG 2: CURVE EDITOR NaN (Color Curves)

### S√≠ntoma:
Al crear curvas de tipo `color` (valueType: 'color'), el path SVG NO se renderizaba. Coordenadas resultaban en `NaN`.

### Root Cause:
En m√∫ltiples lugares del c√≥digo, se asum√≠a que `keyframe.value` era un `number`:
```typescript
const y0 = toY(kf.value as number)  // ‚ùå Si es color, value = { h, s, l } ‚Üí NaN
```

Aunque el `toY()` ten√≠a l√≥gica para manejar objetos HSL, los casts `as number` estaban **antes** de pasarle el valor, causando que se intentara hacer aritm√©tica con objetos.

### Fix:
**Arquitectura**: Crear un helper `getPlotValue()` que extrae el valor num√©rico plotteable:

```typescript
/**
 * Extract the plottable numeric value from a keyframe value.
 * For color curves: uses hue (0-360) normalized to 0-1.
 * For numeric curves: returns the value directly.
 */
function getPlotValue(
  value: number | { h: number; s: number; l: number }, 
  valueType: 'number' | 'color'
): number {
  if (valueType === 'color' && typeof value === 'object' && 'h' in value) {
    return value.h / 360  // Normalize hue to 0-1 for plotting
  }
  return value as number
}
```

### Cambios:

| Ubicaci√≥n | Antes | Despu√©s |
|-----------|-------|---------|
| `toY()` | `value as number` branching | `getPlotValue(value, curve.valueType)` unified |
| Bezier handle drag (l√≠nea 415) | `toY(kf.value as number)` | `toY(kf.value)` |
| Bezier handle drag (l√≠nea 424) | `toY(kf.value as number)` | `toY(kf.value)` |
| Bezier handle render (l√≠nea 698) | `toY(kf.value as number)` √ó 2 | `toY(kf.value)` √ó 2 |

### ¬øPor qu√© esto funciona?
- **Color curves**: `getPlotValue()` devuelve `hue / 360` ‚Üí valor 0-1 ‚Üí `toY()` lo mapea al canvas
- **Numeric curves**: `getPlotValue()` devuelve el valor directo ‚Üí `toY()` aplica range mapping
- **Zero casts**: El tipo union en `toY()` es respetado ‚Üí TypeScript feliz

---

## ARCHIVOS MODIFICADOS

| Archivo | Cambio |
|---------|--------|
| `ChronosLayout.tsx` | Normalizaci√≥n de `audioRealPath` antes de `fetch()` |
| `CurveEditor.tsx` | +`getPlotValue()` helper, `toY()` refactor, removal de `as number` casts |

---

## VALIDACI√ìN

### BUG 1 (Audio Persistence):
1. Cargar audio en Chronos
2. Navegar a Dashboard
3. Volver a Chronos
4. **Antes**: audio no cargaba, consola mostraba fetch error
5. **Despu√©s**: audio carga autom√°ticamente desde path ‚úÖ

### BUG 2 (Color Curve NaN):
1. En Hephaestus Studio, crear curva de tipo `color`
2. A√±adir 2+ keyframes con HSL values
3. **Antes**: path SVG no renderizaba (coordenadas NaN)
4. **Despu√©s**: curva renderiza como l√≠nea suave basada en `hue` (H de HSL) ‚úÖ

---

## LECCIONES

1. **File URLs en Windows**: SIEMPRE normalizar paths a forward slashes antes de construir `file://` URLs
2. **Type casts en coord math**: Si un valor puede ser objeto OR n√∫mero, crear helpers tipados en vez de `as number` everywhere
3. **SVG debugging**: Si un path no renderiza, revisar si alguna coordenada es `NaN` ‚Äî SVG ignora todo el path si una coord es inv√°lida

---

**WAVE 2030.22: BUGFIX PACK ‚Äî SEALED.** üîß‚öíÔ∏è
