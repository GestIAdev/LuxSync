# WAVE 2030.24: THE PRO UPGRADE â€” 16-Bit & Extended Params

**Fecha**: 2026-02-12  
**Status**: âœ… 50/50 TESTS PASSING  
**Archivos modificados**:
- `electron-app/src/core/hephaestus/types.ts`
- `electron-app/src/core/hephaestus/runtime/HephaestusRuntime.ts`
- `electron-app/src/core/orchestrator/TitanOrchestrator.ts`
- `electron-app/src/core/hephaestus/__tests__/HephaestusE2E.test.ts`

---

## ğŸ¯ OBJETIVO

Upgrade del motor Hephaestus a capacidades "Pro":
1. **16-bit movement** â€” Pan/Tilt con resoluciÃ³n de 65536 steps (coarse + fine)
2. **Extended DMX params** â€” zoom, focus, iris, gobo1, gobo2, prism
3. **Audio binding tests** â€” ValidaciÃ³n de modulaciÃ³n reactiva
4. **Multi-clip merging tests** â€” 2+ clips simultÃ¡neos sin borrar datos

---

## âš’ï¸ CAMBIOS DE MOTOR

### 1. HephParamId (types.ts)

Nuevos params aÃ±adidos al union type:

| Param | Escala | Destino |
|-------|--------|---------|
| `zoom` | 0-255 DMX | FixtureState.zoom |
| `focus` | 0-255 DMX | FixtureState.focus |
| `iris` | 0-255 DMX | FixtureState.iris (dynamic) |
| `gobo1` | 0-255 DMX | FixtureState.gobo |
| `gobo2` | 0-255 DMX | FixtureState.gobo2 (dynamic) |
| `prism` | 0-255 DMX | FixtureState.prism |

### 2. HephFixtureOutput (HephaestusRuntime.ts)

Nuevo campo `fine?: number` para 16-bit precision en pan/tilt:

```typescript
interface HephFixtureOutput {
  // ... existing fields ...
  fine?: number      // âš’ï¸ WAVE 2030.24: 16-bit fine byte (LSB) for pan/tilt
}
```

### 3. scaleToDMX â€” ReestructuraciÃ³n Completa

**ANTES (WAVE 2030.21)**:
- pan/tilt: 0-1 â†’ 0-255 (8-bit)
- zoom: engine-internal (0-1 passthrough)

**DESPUÃ‰S (WAVE 2030.24)**:
- pan/tilt: 0-1 â†’ **16-bit** â†’ coarse byte (MSB) como `value`, fine byte (LSB) como `fine`
- zoom/focus/iris/gobo1/gobo2/prism: 0-1 â†’ 0-255 (8-bit DMX)
- speed/width/direction/globalComp: 0-1 passthrough (unchanged)

### 4. scaleToDMX16 â€” Nueva FunciÃ³n

```typescript
export function scaleToDMX16(rawValue: number): { coarse: number; fine: number }
```

Convierte float 0-1 a par {coarse, fine} para canales DMX 16-bit:
- `0.5000` â†’ val16=32768 â†’ coarse=128, fine=0
- `0.5019` â†’ val16=32893 â†’ coarse=128, fine=124
- `1.0000` â†’ val16=65535 â†’ coarse=255, fine=255

### 5. tick() â€” EmisiÃ³n de Fine Channel

Pan y Tilt ahora emiten `output.fine` junto con `output.value` (coarse).

### 6. TitanOrchestrator â€” Merge Expandido

- Pan/Tilt: Ahora propaga `panFine`/`tiltFine` al FixtureState
- Zoom/Focus: LTP overlay a campos existentes de FixtureState
- Iris/Gobo2: LTP overlay a campos dinÃ¡micos
- Gobo1: LTP overlay a `FixtureState.gobo`
- Prism: LTP overlay a `FixtureState.prism`

---

## ğŸ§ª SUITE DE TESTS (50 total)

### Tests anteriores (WAVE 2030.23): 27 tests âœ…
*(Todos actualizados para reflejar el nuevo comportamiento de scaleToDMX)*

### Nuevos tests (WAVE 2030.24): 23 tests âœ…

#### ğŸ”¬ PRUEBA 4: 16-Bit Precision (7 tests)

| Test | VerificaciÃ³n | Status |
|------|-------------|--------|
| scaleToDMX16: 0.5000 | coarse=128, fine=0 | âœ… |
| scaleToDMX16: 0.5019 | coarse=128, fine=124 | âœ… |
| Boundaries 0.0/1.0 | 0\|0 y 255\|255 | âœ… |
| Clamping | Negativos y >1 | âœ… |
| Backward compat | scaleToDMX = scaleToDMX16.coarse | âœ… |
| Fine through merge | panFine travels to FixtureState | âœ… |
| 256 fine values | 256/256 distinct per coarse step | âœ… |

#### ğŸ›ï¸ PRUEBA 5: Extended Params (7 tests)

| Param | Input | Expected DMX | Status |
|-------|-------|-------------|--------|
| Zoom | 0.75 | 191 | âœ… |
| Focus | 0.5 | 128 | âœ… |
| Iris | 1.0 | 255 | âœ… |
| Gobo1 | 0.3 | 77 | âœ… |
| Gobo2 | 0.6 | 153 | âœ… |
| Prism | 0.5 | 128 | âœ… |
| Full Pro Gauntlet | 11 params | All correct | âœ… |

#### ğŸµ PRUEBA 6: Audio Binding (5 tests)

| Test | Energy | Expected | Status |
|------|--------|----------|--------|
| Full modulation | 1.0 | base * 1.0 | âœ… |
| Min modulation | 0.0 | base * 0.2 | âœ… |
| Mid modulation | 0.5 | base * 0.6 | âœ… |
| Bass binding | 0.1/0.6/0.9 | 0/0.5/1.0 | âœ… |
| Full pipeline | 0.75 | DMX=191 | âœ… |

#### ğŸ­ PRUEBA 7: Multi-Clip Merging (4 tests)

| Test | Clips | VerificaciÃ³n | Status |
|------|-------|-------------|--------|
| Color + Position | 2 | Ambos presentes | âœ… |
| 2x Intensity | 2 | HTP picks higher | âœ… |
| 2x Strobe | 2 | Additive sum | âœ… |
| Color + White + Int | 3 | All three present | âœ… |

---

## ğŸ“Š MÃ‰TRICAS

- **50 tests** â€” 0 failures
- **23ms** total execution time
- **0 Math.random()** calls (Axioma Anti-SimulaciÃ³n)
- **0 filesystem** dependencies
- **0 Electron/IPC** dependencies
- **100%** deterministic

---

## ğŸ”¬ DATOS REALES DEL 16-BIT TEST

```
0.5000 â†’ coarse=128, fine=0
0.5019 â†’ coarse=128, fine=124
0.0000 â†’ coarse=0,   fine=0
1.0000 â†’ coarse=255, fine=255
Distinct fine values for coarse=128: 256/256  â† FULL RESOLUTION
```

## ğŸ›ï¸ DATOS DEL PRO GAUNTLET (11 params)

```
Dimmer=255 RGB=(0,255,0)
White=204 Amber=153 Strobe=64
Zoom=191 Focus=128 Iris=230
Gobo1=77 Gobo2=153 Prism=102
```

---

## ğŸ”— BACKWARD COMPATIBILITY

- `scaleToDMX('pan', x)` sigue retornando un nÃºmero 0-255 (ahora el coarse byte)
- Todos los consumidores existentes que solo usan `output.value` siguen funcionando
- El campo `fine` es OPCIONAL â€” solo se usa si el fixture soporta 16-bit
- Los tests de WAVE 2030.23 siguen pasando (actualizados para nuevo comportamiento)
