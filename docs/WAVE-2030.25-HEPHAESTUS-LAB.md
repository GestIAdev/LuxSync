# ğŸ›° WAVE 2030.25: THE HEPHAESTUS LAB â€” Standalone Radar Preview

**Fecha**: Junio 2025  
**Estado**: âœ… COMPLETADO  
**Tests**: 206/206 ALL GREEN  

---

## ğŸ¯ Objetivo

Crear un **minilaboratorio visual** dentro del editor Hephaestus que permite previsualizar clips de curvas **sin desplegar al motor Chronos** ni pasar por TitanOrchestrator. El diseÃ±ador de iluminaciÃ³n puede ver en tiempo real cÃ³mo se mueven los fixtures, quÃ© color emiten, y leer los valores DMX numÃ©ricos, todo desde el mismo editor de curvas.

---

## ğŸ—ï¸ Arquitectura

### El Bypass
```
ANTES:  CurveEditor â†’ HephaestusRuntime â†’ TitanOrchestrator â†’ Chronos â†’ Stage
AHORA:  CurveEditor â†’ useHephPreview (hook puro) â†’ HephRadar (Canvas 2D) â†’ ojo humano
```

### DecisiÃ³n Clave: No instanciar HephaestusRuntime
`HephaestusRuntime` importa `fs` y `path` (Node.js). En el renderer process de Electron eso es un import envenenado. En su lugar, el hook importa directamente las funciones puras:
- `CurveEvaluator` â€” O(1) amortizado, Newton-Raphson para bÃ©zier
- `scaleToDMX` â€” ConversiÃ³n 0-1 â†’ 0-255 para DMX params
- `scaleToDMX16` â€” ConversiÃ³n 0-1 â†’ coarse+fine (16-bit) para pan/tilt
- `hslToRgb` â€” HSL â†’ RGB para el color curve

---

## ğŸ“ Archivos

### Nuevos
| Archivo | LOC | PropÃ³sito |
|---------|-----|-----------|
| `useHephPreview.ts` | ~270 | Hook React: motor de preview con rAF loop |
| `HephRadar.tsx` | ~310 | Componente Canvas 2D: radar visual |

### Modificados
| Archivo | Cambio |
|---------|--------|
| `index.tsx` | IntegraciÃ³n del radar + toggle ğŸ›° |
| `HephaestusView.css` | +170 lÃ­neas: layout radar, transport bar, animaciones |
| `ParameterLane.tsx` | +5 params en PARAM_META (focus, iris, gobo1, gobo2, prism) |
| `HephTranslator.test.ts` | Actualizado: zoom â†’ DMX-scaled, +6 extended params en dmxParams |

---

## ğŸ”¬ useHephPreview â€” El Motor Aislado

### Interfaces
```typescript
PreviewFixtureState {
  dimmer, r, g, b, pan, panFine, tilt, tiltFine,
  white, amber, strobe, zoom, focus
}

HephPreviewState {
  playheadMs, progress, isPlaying, fixtures[], frameCount,
  play(), pause(), stop(), seek(t)
}
```

### EvaluaciÃ³n de Frame
1. Itera `clip.curves[]`
2. EvalÃºa cada curva con `CurveEvaluator.evaluate(paramId, timeMs)`
3. Si `paramId === 'color'` â†’ `evaluateColor()` â†’ `hslToRgb()`
4. Si 16-bit (`pan`/`tilt`) â†’ `scaleToDMX16()` â†’ coarse + fine
5. Si DMX-scaled â†’ `scaleToDMX()` â†’ 0-255
6. Si float passthrough â†’ clamp 0-1

### ResoluciÃ³n de Fixtures
- **1 zona** â†’ 1 dot grande (radio 16px)
- **Multi-zona** â†’ 4 dots (radio 10px) con offsets de fase: 0/50/100/150ms
- Las posiciones se distribuyen en cuadrantes: (0.3, 0.3), (0.7, 0.3), (0.3, 0.7), (0.7, 0.7)

---

## ğŸ¨ HephRadar â€” El Canvas Cyberpunk

### Capas de Rendering (pintadas en orden)
1. **Background**: Negro profundo `#0a0a0f`
2. **Grid**: 8Ã—8 subdivisiones, crucero central con dash, scanlines CRT
3. **Fixture Dots**: Gradiente radial (glow â†’ core â†’ bright center)
4. **Readouts**: 4 esquinas con valores numÃ©ricos
5. **Progress Bar**: Barra con glow ember en la posiciÃ³n del playhead
6. **Transport Bar**: â–¶â¸ / â¹ / LIVE indicator / frame counter

### CÃ³mputo de Color de Fixture
```
baseR = fixture.r + (fixture.white * 0.2) + (fixture.amber * 0.3)
baseG = fixture.g + (fixture.white * 0.2) + (fixture.amber * 0.15)
baseB = fixture.b + (fixture.white * 0.2)
alpha = (fixture.dimmer / 255) Ã— strobeGate
```
Si no hay color (R+G+B = 0), fallback a warm white `(255, 220, 180)`.

### Strobe Gate
```
strobeGate = (fixture.strobe === 0) ? 1.0 : (sin(time Ã— freq Ã— 2Ï€) > 0 ? 1 : 0)
freq = (fixture.strobe / 255) Ã— 18  // 0-18 Hz
```

---

## ğŸ›ï¸ Layout CSS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  heph-canvas-area (flex column)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  __editor (flex:1, CurveEditor)    â”‚  â”‚
â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  [SVG curves + keyframes]           â”‚  â”‚
â”‚  â”‚                                     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  __radar (260px fixed, collapsible)â”‚  â”‚
â”‚  â”‚  â”Œâ”€ header: ğŸ›° RADAR PREVIEW [âœ•] â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  Canvas 2D: grid + dots + text  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  [transport: â–¶ â¹ LIVE f:1234]  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§¹ Cleanup Adicional

### ParameterLane PARAM_META sync (from WAVE 2030.24)
Los 5 params nuevos de WAVE 2030.24 (`focus`, `iris`, `gobo1`, `gobo2`, `prism`) faltaban en `PARAM_META` y `ALL_PARAM_IDS`. Ahora estÃ¡n presentes con iconos y colores asignados:

| Param | Icon | Color | Category |
|-------|------|-------|----------|
| focus | â— | `#0ea5e9` | movement |
| iris | â¦¿ | `#8b5cf6` | movement |
| gobo1 | â¬¡ | `#d946ef` | movement |
| gobo2 | â¬¢ | `#c026d3` | movement |
| prism | â—‡ | `#f43f5e` | movement |

### HephTranslator.test.ts sync (from WAVE 2030.24)
- `zoom` movido de `floatParams` â†’ `dmxParams` (ahora escala a 0-255)
- Agregados `focus`, `iris`, `gobo1`, `gobo2`, `prism` a `dmxParams`
- Tests: 206/206 ALL GREEN

---

## ğŸ“Š Score Final

| MÃ©trica | Valor |
|---------|-------|
| Tests totales | 206/206 âœ… |
| Errores TS (scope) | 0 |
| Archivos nuevos | 2 |
| Archivos modificados | 4 |
| LOC aÃ±adidas | ~750 |
| Dependencias nuevas | 0 |
| Canvas API usado | âœ… Canvas 2D puro |
| Axioma Anti-SimulaciÃ³n | âœ… Todo es evaluaciÃ³n real de curvas |

---

*"El radar no miente. Lo que ves es lo que el fixture harÃ¡."* â€” PunkOpus
