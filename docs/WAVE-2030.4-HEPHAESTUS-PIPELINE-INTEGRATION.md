# WAVE 2030.4 - HEPHAESTUS PIPELINE INTEGRATION

## Status: âœ… COMPLETE
**Date**: 2025-01-XX  
**Author**: PunkOpus  
**Dependency**: WAVE 2030.3 (HephaestusView)

---

## ğŸ¯ OBJECTIVE

Integrar el sistema de curvas Hephaestus en el pipeline de efectos de LuxSync, permitiendo que los clips de Chronos transporten datos de automatizaciÃ³n y que el EffectManager los aplique en tiempo real sobre el output de los efectos.

---

## ğŸ“ ARQUITECTURA

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CHRONOS TIMELINE                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚   FXClip    â”‚                                                        â”‚
â”‚  â”‚  + hephClip â”‚â—„â”€â”€ HephAutomationClip (Map<HephParamId, HephCurve>)   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CHRONOS INJECTOR                                   â”‚
â”‚  ChronosInjector.tick()                                                 â”‚
â”‚  â””â”€â”€â–º emit StageCommand { effect, intensity, hephCurves }               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼ IPC (requires serialization)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CHRONOS IPC BRIDGE                                  â”‚
â”‚  serializeHephClip(hephCurves)                                          â”‚
â”‚  â””â”€â”€â–º Map<> â†’ Record<> (JSON-safe)                                      â”‚
â”‚  ipcRenderer.invoke('chronos:triggerFX', effect, intensity, serialized) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        IPC HANDLERS                                      â”‚
â”‚  deserializeHephClip(serialized)                                        â”‚
â”‚  â””â”€â”€â–º Record<> â†’ Map<> (restored)                                       â”‚
â”‚  orchestrator.forceStrikeNextFrame({ effect, intensity, hephCurves })   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TITAN ORCHESTRATOR                                   â”‚
â”‚  forceStrikeNextFrame(config: ForceStrikeConfig)                        â”‚
â”‚  â””â”€â”€â–º Sets manualStrikePending with full config                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TITAN ENGINE                                      â”‚
â”‚  On next frame: effectManager.trigger({ effect, intensity, hephCurves })â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       EFFECT MANAGER                                     â”‚
â”‚  trigger(config):                                                       â”‚
â”‚    if (config.hephCurves) {                                             â”‚
â”‚      overlay = new HephParameterOverlay(config.hephCurves)              â”‚
â”‚      hephOverlays.set(effect.id, overlay)                               â”‚
â”‚      overlayStartTimes.set(effect.id, performance.now())                â”‚
â”‚    }                                                                    â”‚
â”‚                                                                         â”‚
â”‚  getCombinedOutput():                                                   â”‚
â”‚    for each active effect:                                              â”‚
â”‚      rawOutput = effect.getOutput()                                     â”‚
â”‚      if (hephOverlays.has(effect.id)) {                                 â”‚
â”‚        elapsedMs = now - overlayStartTimes.get(effect.id)               â”‚
â”‚        rawOutput = overlay.apply(rawOutput, elapsedMs)                  â”‚
â”‚      }                                                                  â”‚
â”‚      combine(rawOutput)                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ CHANGES

### 1. Type Definitions

#### `core/effects/types.ts`
```typescript
import type { HephAutomationClip } from '../hephaestus/types'

interface EffectTriggerConfig {
  // ... existing fields
  hephCurves?: HephAutomationClip  // NEW: Optional Hephaestus automation
}
```

#### `chronos/core/ChronosInjector.ts`
```typescript
interface StageCommand {
  // ... existing fields
  hephCurves?: HephAutomationClip  // NEW: Automation curves for the effect
}
```

#### `chronos/core/TimelineClip.ts`
```typescript
interface FXClip extends BaseClip {
  // ... existing fields
  hephClip?: HephAutomationClip  // NEW: Optional embedded automation clip
}
```

#### `core/orchestrator/TitanOrchestrator.ts`
```typescript
// NEW: Type for manual strike configuration
export type ForceStrikeConfig = {
  effect: string
  intensity: number
  source?: 'manual' | 'chronos'
  hephCurves?: HephAutomationClip
}
```

### 2. IPC Serialization

**Problem**: JavaScript `Map<>` doesn't serialize over Electron IPC.

**Solution**: Created serialize/deserialize functions in `core/hephaestus/types.ts`:

```typescript
// Record-based type for IPC transport
export type SerializedHephAutomationClip = {
  durationMs: number
  curves: Record<HephParamId, HephCurve>  // Record instead of Map
}

// Serialize before IPC send
export function serializeHephClip(clip: HephAutomationClip): SerializedHephAutomationClip {
  return {
    durationMs: clip.durationMs,
    curves: Object.fromEntries(clip.curves)
  }
}

// Deserialize after IPC receive
export function deserializeHephClip(serialized: SerializedHephAutomationClip): HephAutomationClip {
  return {
    durationMs: serialized.durationMs,
    curves: new Map(Object.entries(serialized.curves))
  }
}
```

### 3. HephParameterOverlay Enhancement

Added `getDurationMs()` getter for timing and cleanup:

```typescript
export class HephParameterOverlay {
  private readonly evaluator: CurveEvaluator
  private readonly durationMs: number

  constructor(clip: HephAutomationClip) {
    this.evaluator = new CurveEvaluator(clip.curves, clip.durationMs)
    this.durationMs = clip.durationMs
  }

  getDurationMs(): number {
    return this.durationMs
  }
}
```

### 4. EffectManager Integration

New private state:
```typescript
private hephOverlays: Map<string, HephParameterOverlay> = new Map()
private overlayStartTimes: Map<string, number> = new Map()
```

Modified `trigger()`:
- Creates overlay when `config.hephCurves` is present
- Stores overlay keyed by effect.id
- Records start time for elapsed calculation

Modified `getCombinedOutput()`:
- For each active effect with overlay, applies `overlay.apply(rawOutput, elapsedMs)`
- Produces final output with Hephaestus modulation applied

---

## ğŸ“ FILES MODIFIED

| File | Changes |
|------|---------|
| `core/effects/types.ts` | Added `hephCurves` to `EffectTriggerConfig` |
| `chronos/core/ChronosInjector.ts` | Added `hephCurves` to `StageCommand` |
| `chronos/core/TimelineClip.ts` | Added `hephClip` to `FXClip` |
| `core/hephaestus/types.ts` | Added `SerializedHephAutomationClip`, `serializeHephClip()`, `deserializeHephClip()` |
| `core/hephaestus/index.ts` | Updated exports |
| `chronos/bridge/ChronosIPCBridge.ts` | Serialize hephCurves before IPC |
| `electron/preload.ts` | Extended `triggerFX` signature (2 locations) |
| `core/orchestrator/IPCHandlers.ts` | Deserialize hephCurves, pass to orchestrator |
| `core/orchestrator/TitanOrchestrator.ts` | Added `ForceStrikeConfig` type, updated signature |
| `engine/TitanEngine.ts` | Pass hephCurves through to EffectManager |
| `core/effects/EffectManager.ts` | Create overlays, apply during output |
| `core/hephaestus/HephParameterOverlay.ts` | Added `getDurationMs()` |

---

## âœ… VERIFICATION

### TypeScript Compilation
```
npx tsc --noEmit
# 0 errors in WAVE 2030.4 files
```

### Hephaestus Tests
```
npx vitest run hephaestus
# 58/58 passing in 32ms
```

---

## ğŸ¨ USAGE EXAMPLE

```typescript
// Creating an FX clip with automation
const fxClip: FXClip = {
  id: 'clip-001',
  type: 'fx',
  startTime: 0,
  duration: 4000,
  effect: 'rainbow_pulse',
  intensity: 1.0,
  hephClip: {
    durationMs: 4000,
    curves: new Map([
      ['intensity', {
        mode: 'absolute',
        keyframes: [
          { timeMs: 0, value: 0.2 },
          { timeMs: 2000, value: 1.0, interpolation: 'bezier', handles: [0.4, 0, 0.2, 1] },
          { timeMs: 4000, value: 0.2 }
        ]
      }],
      ['strobe', {
        mode: 'absolute',
        keyframes: [
          { timeMs: 0, value: 0 },
          { timeMs: 1000, value: 0.5, interpolation: 'hold' },
          { timeMs: 3000, value: 0 }
        ]
      }]
    ])
  }
}

// When ChronosInjector.tick() fires this clip:
// 1. StageCommand includes hephCurves
// 2. IPC serializes Map â†’ Record
// 3. Main process deserializes Record â†’ Map
// 4. EffectManager creates HephParameterOverlay
// 5. Every frame: overlay.apply(rawOutput, elapsedMs)
// 6. Intensity and strobe are modulated by curves
```

---

## ğŸ”® FUTURE WORK (WAVE 2030.5+)

1. **Overlay Cleanup**: Implement automatic removal of overlays when effect dies or clip ends
2. **HephaestusView Integration**: UI to create/edit HephAutomationClips attached to FXClips
3. **Curve Preview**: Real-time visualization of curve values in the timeline
4. **Performance Telemetry**: Measure overhead of overlay application

---

## ğŸ CONCLUSION

WAVE 2030.4 completes the backend integration of Hephaestus into the LuxSync effect pipeline. Automation curves defined in Hephaestus can now flow from Chronos timeline clips through IPC to the EffectManager, where they modulate the real-time output of effects.

**The invisible hand of Hephaestus now shapes the light.**

---
*PunkOpus - El cÃ³digo como arte, la luz como lienzo*
