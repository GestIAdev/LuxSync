# WAVE 2030.5 - HEPHAESTUS FILE I/O & LIBRARY

## Status: âœ… COMPLETE
**Date**: 2025-02-11  
**Author**: PunkOpus  
**Dependency**: WAVE 2030.4 (Pipeline Integration)

---

## ğŸ¯ OBJECTIVE

Reemplazar los datos dummy de Hephaestus con un sistema de persistencia real.
Los clips de automatizaciÃ³n se guardan como archivos `.lfx` en `userData/effects/`.

---

## ğŸ“ ARQUITECTURA

### Storage Location
```
%APPDATA%/luxsync-electron/effects/
â”œâ”€â”€ acid-sweep-demo.lfx
â”œâ”€â”€ rainbow-pulse.lfx
â”œâ”€â”€ strobe-burst.lfx
â””â”€â”€ ...
```

### .LFX File Format
```typescript
interface LFXFile {
  $schema: 'hephaestus/v1'     // Migration support
  version: '1.0.0'
  clip: HephAutomationClipSerialized
  checksum: string             // SHA-256 for integrity
}
```

### Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FRONTEND (HephaestusView)                           â”‚
â”‚                                                                          â”‚
â”‚  [Save] â†’ serializeHephClip(clip) â†’ window.luxsync.hephaestus.save()   â”‚
â”‚  [Load] â† deserializeHephClip(data) â† window.luxsync.hephaestus.load() â”‚
â”‚  [List] â† metadata[] â† window.luxsync.hephaestus.list()                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ IPC
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IPC HANDLERS (HephIPCHandlers.ts)                     â”‚
â”‚                                                                          â”‚
â”‚  heph:save   â†’ hephFileIO.saveClip(clip)                                â”‚
â”‚  heph:load   â†’ hephFileIO.loadClip(idOrPath)                            â”‚
â”‚  heph:list   â†’ hephFileIO.listClips() â†’ metadata[]                      â”‚
â”‚  heph:delete â†’ hephFileIO.deleteClip(idOrPath)                          â”‚
â”‚  heph:exists â†’ hephFileIO.clipExists(name)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     HEPH FILE I/O (HephFileIO.ts)                        â”‚
â”‚                                                                          â”‚
â”‚  getEffectsPath() â†’ userData/effects/                                   â”‚
â”‚  saveClip(clip)   â†’ serialize â†’ checksum â†’ write .lfx                  â”‚
â”‚  loadClip(id)     â†’ read â†’ verify checksum â†’ deserialize               â”‚
â”‚  listClips()      â†’ scan folder â†’ extract metadata only                â”‚
â”‚  deleteClip(id)   â†’ find file â†’ unlink                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ NEW FILES

### 1. `core/hephaestus/HephFileIO.ts`

Backend persistence class. Singleton exported as `hephFileIO`.

**Key Methods:**
```typescript
// Get/create effects folder
async getEffectsPath(): Promise<string>

// Generate unique clip ID (heph-{timestamp}-{random})
generateId(): string

// Save clip with checksum
async saveClip(clip: HephAutomationClip): Promise<string>

// Load by ID or file path
async loadClip(idOrPath: string): Promise<HephAutomationClip>

// List all clips (metadata only, no curves)
async listClips(): Promise<HephClipMetadata[]>

// Delete by ID or path
async deleteClip(idOrPath: string): Promise<boolean>

// Check if name exists
async clipExists(name: string): Promise<boolean>
```

### 2. `core/hephaestus/HephIPCHandlers.ts`

IPC handlers registered at app startup.

**Channels:**
| Channel | Description |
|---------|-------------|
| `heph:save` | Save clip to disk |
| `heph:load` | Load clip by ID |
| `heph:list` | List all clips |
| `heph:delete` | Delete clip |
| `heph:exists` | Check name exists |
| `heph:getPath` | Get effects folder |
| `heph:generateId` | Generate unique ID |

### 3. Updated `electron/main.ts`

Added initialization:
```typescript
import { setupHephIPCHandlers } from '../src/core/hephaestus'

// In initTitan():
setupHephIPCHandlers()
console.log('[Main] âš’ï¸ Hephaestus File I/O initialized (WAVE 2030.5)')
```

### 4. Updated `electron/preload.ts`

Exposed API to renderer:
```typescript
hephaestus: {
  save: (clipData) => ipcRenderer.invoke('heph:save', clipData),
  load: (idOrPath) => ipcRenderer.invoke('heph:load', idOrPath),
  list: () => ipcRenderer.invoke('heph:list'),
  delete: (idOrPath) => ipcRenderer.invoke('heph:delete', idOrPath),
  exists: (name) => ipcRenderer.invoke('heph:exists', name),
  getPath: () => ipcRenderer.invoke('heph:getPath'),
  generateId: () => ipcRenderer.invoke('heph:generateId'),
}
```

### 5. Updated `src/vite-env.d.ts`

Added type declarations:
```typescript
interface HephClipMetadata {
  id: string
  name: string
  author: string
  category: string
  tags: string[]
  durationMs: number
  effectType: string
  paramCount: number
  filePath: string
  modifiedAt: number
}

interface Window {
  luxsync: {
    hephaestus: {
      save: (clipData: unknown) => Promise<...>
      load: (idOrPath: string) => Promise<...>
      list: () => Promise<...>
      delete: (idOrPath: string) => Promise<...>
      exists: (name: string) => Promise<...>
      getPath: () => Promise<...>
      generateId: () => Promise<...>
    }
  }
}
```

---

## ğŸ¨ UI CHANGES

### Updated `HephaestusView/index.tsx`

**New State:**
```typescript
const [library, setLibrary] = useState<LibraryClip[]>([])
const [isLoadingLibrary, setIsLoadingLibrary] = useState(false)
const [isSaving, setIsSaving] = useState(false)
const [isDirty, setIsDirty] = useState(false)
const [showLibrary, setShowLibrary] = useState(true)
const [saveMessage, setSaveMessage] = useState<string | null>(null)
```

**New Features:**
- ğŸ“š **Library Panel** - Collapsible left sidebar showing all saved clips
- ğŸ’¾ **Save Button** - Persists current clip to disk
- ğŸ“„ **New Button** - Creates fresh clip with unique ID
- ğŸ—‘ï¸ **Delete** - Remove clips from library
- âœ¨ **Dirty Indicator** - Asterisk (*) when unsaved changes exist
- âœ… **Save Feedback** - Brief message confirming save success/failure

**New Callbacks:**
```typescript
loadLibrary()     // Fetch all clips on mount
handleSave()      // Serialize and save current clip
handleLoad(id)    // Load clip from library
handleDelete(id)  // Delete with confirmation
handleNew()       // Create fresh clip
```

### New CSS (HephaestusView.css)

Added ~120 lines for:
- `.heph-header__btn` - Action buttons (NEW, SAVE, toggle)
- `.heph-header__dirty` - Unsaved changes indicator
- `.heph-library` - Library panel container
- `.heph-library__item` - Clip list items with hover/active states
- Animation for dirty pulse

---

## ğŸ“ FILES MODIFIED

| File | Changes |
|------|---------|
| `core/hephaestus/HephFileIO.ts` | **NEW** - Backend persistence |
| `core/hephaestus/HephIPCHandlers.ts` | **NEW** - IPC handlers |
| `core/hephaestus/index.ts` | Updated exports |
| `electron/main.ts` | Added import + setup call |
| `electron/preload.ts` | Added `hephaestus` API |
| `src/vite-env.d.ts` | Added `HephClipMetadata` + window types |
| `views/HephaestusView/index.tsx` | Complete rewrite with persistence |
| `views/HephaestusView/HephaestusView.css` | Added library + button styles |

---

## âœ… VERIFICATION

### TypeScript Compilation
```
npx tsc --noEmit
# 0 errors in WAVE 2030.5 files
```

### Hephaestus Tests
```
npx vitest run hephaestus
# 58/58 passing in 32ms
```

---

## ğŸ® USAGE

### Creating & Saving a Clip
1. Open Hephaestus Studio
2. Edit curves in the editor
3. Click ğŸ’¾ SAVE
4. Clip appears in Library panel

### Loading a Clip
1. Click on clip in Library
2. Curves load into editor
3. Edit and save changes

### File Location
```powershell
# Windows
%APPDATA%\luxsync-electron\effects\*.lfx

# macOS
~/Library/Application Support/luxsync-electron/effects/*.lfx

# Linux
~/.config/luxsync-electron/effects/*.lfx
```

---

## ğŸ”® FUTURE WORK

1. **Export to Chronos** - Drag clip to timeline or "Use in Timeline" button
2. **Import/Export** - Share .lfx files between users
3. **Clip Thumbnails** - Mini curve preview in library
4. **Categories/Filtering** - Organize by effect type
5. **Undo/Redo** - History stack for curve edits

---

## ğŸ CONCLUSION

WAVE 2030.5 completes the file I/O layer for Hephaestus. Users can now:
- Create automation clips with multi-parameter curves
- Save clips to persistent storage
- Browse and load from a library of saved clips
- Delete unwanted clips

**The forge now remembers its creations.**

---

## ğŸ“Š WAVE 2030 SERIES STATUS

| Wave | Name | Status |
|------|------|--------|
| 2030.1 | Blueprint & Types | âœ… COMPLETE |
| 2030.2 | CurveEvaluator Engine | âœ… COMPLETE |
| 2030.3 | HephaestusView UI | âœ… COMPLETE |
| 2030.4 | Pipeline Integration | âœ… COMPLETE |
| **2030.5** | **File I/O & Library** | **âœ… COMPLETE** |
| 2030.6 | Chronos Integration | ğŸ”® NEXT |

---
*PunkOpus - El cÃ³digo como arte, la luz como lienzo*
