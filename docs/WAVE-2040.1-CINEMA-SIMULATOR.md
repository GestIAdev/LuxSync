# WAVE 2040.1: THE CINEMA SIMULATOR

**Commit:** `047f001`  
**Fecha:** 2025-01-XX  
**Tests:** 488/488 âœ… (87 fallas pre-existentes por better-sqlite3 native module mismatch)

---

## ğŸ¬ QUÃ‰ SE HIZO

Reemplazo total del `StagePreview` (367 LOC, single canvas, gradientes radiales bÃ¡sicos) por un **Stage Simulator Cinema** (530+ LOC) con arquitectura de doble buffer Canvas 2D, proyecciÃ³n vectorial de beams, estelas de movimiento, e indicadores de gobo/prism.

### Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Canvas A (trails)  â€” z-index: 1      â”‚  â† mix-blend-mode: screen
â”‚  Canvas B (fixtures) â€” z-index: 0     â”‚  â† cleared + full redraw each frame  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Trails Canvas**: NO se limpia nunca. Se pinta `rgba(8,8,13, 0.08)` encima cada frame (long-exposure decay). Puntos de movimiento se pintan como ecos. `mix-blend-mode: screen` para que aÃ±adan luz a la escena.
- **Fixtures Canvas**: Limpieza total + redraw completo cada frame (30fps). Background â†’ grid â†’ stage line â†’ beams â†’ fixture dots.

### Beam Math (Vectorial)

```
angle  = map(physicalPan, 0â†’1, -Ï€*0.45â†’Ï€*0.45)   // Rotation
length = physicalTilt parabolic (max at 0.5)        // Throw distance
width  = map(zoom, 0â†’255, 4Â°â†’60Â°)                  // Cone angle
focus  â†’ edge alpha falloff (0=sharp â†’ 255=diffuse)
```

Cada beam es un **triÃ¡ngulo relleno** con gradiente lineal a lo largo del eje de proyecciÃ³n. El vertex estÃ¡ en el fixture, la base estÃ¡ a `length` de distancia con apertura `width`.

### Zone Auto-Layout

| Zone | X Center | Y | Spread | Distribution |
|------|----------|---|--------|--------------|
| BACK_PARS | 0.50 | 0.18 | 0.70 | Arc horizontal |
| AIR | 0.50 | 0.32 | 0.40 | Arc horizontal |
| MOVING_LEFT | 0.12 | variable | â€” | Vertical (0.30â†’0.65) |
| CENTER | 0.50 | 0.50 | 0.30 | Arc horizontal |
| STROBES | 0.50 | 0.50 | 0.50 | Arc horizontal |
| MOVING_RIGHT | 0.88 | variable | â€” | Vertical (0.30â†’0.65) |
| FRONT_PARS | 0.50 | 0.78 | 0.70 | Arc horizontal |
| AMBIENT | 0.50 | 0.90 | 0.80 | Arc horizontal |
| FLOOR | 0.50 | 0.92 | 0.80 | Arc horizontal |

### Indicadores Ã“pticos

- **Gobo**: Estrella de 6 puntas dentro del cÃ­rculo del fixture. RotaciÃ³n determinista por valor de gobo (`gobo/255 * 2Ï€`). Solo visible cuando gobo > 5.
- **Prism**: 3 puntos de refracciÃ³n a 120Â° alrededor del fixture. Alpha escalado por valor de prism. Solo visible cuando prism > 5.

### Trail Logic

Solo para fixtures tipo `moving` con velocidad activa:
```
speed = |panVelocity| + |tiltVelocity|
if speed < 0.005 â†’ no trail
trailAlpha = min(0.4, speed * 0.8) * intensity
```

---

## ğŸ“ ARCHIVOS

| Archivo | AcciÃ³n | LOC |
|---------|--------|-----|
| `StageSimulatorCinema.tsx` | **NUEVO** | 530 |
| `StageSimulatorCinema.css` | **NUEVO** | 93 |
| `ChronosLayout.tsx` | **MODIFICADO** | 2 lÃ­neas (import swap) |
| `StagePreview.tsx` | **INTACTO** (legacy, ya no se importa) | 367 |

### Drop-in Replacement

El nuevo componente exporta `StagePreview` (mismo nombre) con la misma interfaz `{ visible?: boolean, className?: string }`. ChronosLayout solo necesitÃ³ cambiar la ruta de import:

```diff
-import { StagePreview } from './stage/StagePreview'
+import { StagePreview } from './stage/StageSimulatorCinema'
```

---

## ğŸ”§ DATA PIPELINE

```
useTruthStore (hardware.fixtures) 
  â†’ runtimeStateMap (Map<id, FixtureState>)
  â†’ calculateFixtureRenderValues() 
  â†’ CinemaFixture[] (extended: physicalPan, physicalTilt, zoom, focus, gobo, prism)
  â†’ Zone layout pass (arc/vertical distribution)
  â†’ Double-buffer render
```

### CinemaFixture vs FixtureVisualLite

| Campo | Old (FixtureVisualLite) | New (CinemaFixture) |
|-------|------------------------|---------------------|
| color | r, g, b | r, g, b |
| intensity | âœ… | âœ… |
| type | par/moving/strobe/laser | par/moving/strobe/laser/wash |
| zone | front/back/left/right/center | 9 CinemaZones |
| physicalPan | âŒ | âœ… (0-1) |
| physicalTilt | âŒ | âœ… (0-1) |
| zoom | âŒ | âœ… (0-255) |
| focus | âŒ | âœ… (0-255) |
| gobo | âŒ | âœ… (0-255, dynamic from TitanOrchestrator) |
| prism | âŒ | âœ… (0-255, dynamic from TitanOrchestrator) |
| panVelocity | âŒ | âœ… |
| tiltVelocity | âŒ | âœ… |

---

## âš¡ PERFORMANCE

- **30fps limiter** (misma estrategia que StagePreview)
- **DPR-aware** ResizeObserver (cap a 2x)
- **Trails canvas never clears** â†’ solo alpha overlay (mÃ­nimo fill)
- **Fixtures canvas full redraw** â†’ clearRect + paint (no compositing state leak)
- **Zero allocations in render loop** â€” todas las funciones de draw reciben primitivos
- **No Math.random** â€” axioma anti-simulaciÃ³n respetado

---

## ğŸ“Š ZERO REGRESSIONS

```
Tests:  488 passed / 87 failed (pre-existing: better-sqlite3 NODE_MODULE_VERSION mismatch)
TS:     0 new errors (77 pre-existing)
```
