# ðŸ›¡ï¸ WAVE 1008.3 - SAFETY SHIELD
**"No More Belt Scrapings"**

---

## ðŸ“‹ EXECUTIVE SUMMARY

**Problem:** EL-1140 moving head has physical limits (Pan 540Â°, Tilt 270Â°) that, if exceeded, can scrape motor belts and damage hardware.

**Solution:** Implemented 95% safety margin across entire UI stack:
- Pan: 513Â° max (95% of 540Â°) = 242 DMX max
- Tilt: 256Â° max (95% of 270Â°) = 241 DMX max

**Impact:** Hardware protection at code level - impossible to send dangerous values even if user drags sliders to max.

---

## ðŸŽ¯ CHANGES IMPLEMENTED

### 1. **CalibrationView/index.tsx**

**Constants Added:**
```tsx
const SAFE_PAN_MAX = 513   // 95% of 540Â°
const SAFE_TILT_MAX = 256  // 95% of 270Â°
```

**Safety Clamps in handlePositionChange:**
```tsx
const safePan = Math.max(0, Math.min(SAFE_PAN_MAX, newPan))
const safeTilt = Math.max(0, Math.min(SAFE_TILT_MAX, newTilt))

// DMX conversion with additional safety cap
const panDmx = Math.min(242, Math.round((safePan / 540) * 255))
const tiltDmx = Math.min(241, Math.round((safeTilt / 270) * 255))
```

**Center Position Updated:**
```tsx
const centerPan = Math.round(SAFE_PAN_MAX / 2)   // ~256Â°
const centerTilt = Math.round(SAFE_TILT_MAX / 2) // ~128Â°
```

---

### 2. **RadarXY.tsx**

**Safety Constants:**
```tsx
const SAFE_PAN_MAX = 513
const SAFE_TILT_MAX = 256
```

**Normalized Display:**
```tsx
// Uses SAFE limits, not physical max!
const normalizedX = pan / SAFE_PAN_MAX
const normalizedY = tilt / SAFE_TILT_MAX
```

**Mouse Position Handler:**
```tsx
// Convert to degrees using SAFE limits (95% of physical max)
const newPan = Math.round(x * SAFE_PAN_MAX)   // Max 513Â° (not 540Â°)
const newTilt = Math.round(y * SAFE_TILT_MAX) // Max 256Â° (not 270Â°)
```

---

### 3. **Fixture Profile (EL_1140.json)**

**panLimits Added:**
```json
"panLimits": {
  "min": 0,
  "max": 242  // DMX units (95% safety)
}
```

**tiltLimits Updated:**
```json
"tiltLimits": {
  "min": 0,
  "max": 241  // DMX units (95% safety)
}
```

**Physics Config:**
```json
"physics": {
  "motorType": "stepper-cheap",
  "maxAcceleration": 1500,
  "maxVelocity": 400,
  "safetyCap": true,
  "orientation": "floor",
  "invertPan": false,
  "invertTilt": false,
  "swapPanTilt": false,
  "homePosition": {
    "pan": 127,
    "tilt": 127
  },
  "tiltLimits": {
    "min": 0,
    "max": 241
  },
  "panLimits": {
    "min": 0,
    "max": 242
  }
}
```

---

## ðŸ“ SAFETY MATHEMATICS

### Physical Specs (from EL-1140 manual):
- **Pan:** 540Â° max
- **Tilt:** 270Â° max

### Safety Margin Calculation:
```
Safety Factor: 95% (leaves 5% buffer)

Pan Safe Max:
  540Â° Ã— 0.95 = 513Â°
  
Tilt Safe Max:
  270Â° Ã— 0.95 = 256Â°
```

### DMX Conversion:
```
DMX Range: 0-255 (8-bit)

Pan DMX Calculation:
  540Â° / 255 = 2.118Â° per DMX unit
  513Â° / 2.118 = 242.2 DMX â†’ 242 DMX max
  
Tilt DMX Calculation:
  270Â° / 255 = 1.059Â° per DMX unit
  256Â° / 1.059 = 241.7 DMX â†’ 241 DMX max
```

### Real-World Protection:
```
Pan DMX 242 = 512.356Â° (0.644Â° safety buffer)
Tilt DMX 241 = 255.219Â° (14.781Â° safety buffer)

Total Safety Margins:
  Pan:  27Â° buffer (540Â° - 513Â°) + 0.6Â° rounding = ~27.6Â° total
  Tilt: 14Â° buffer (270Â° - 256Â°) + 0.8Â° rounding = ~14.8Â° total
```

---

## ðŸ”’ PROTECTION LAYERS

### Layer 1: UI Input Clamping
**Location:** `RadarXY.tsx` handleMousePosition  
**Protection:** User cannot drag beyond safe limits in UI

### Layer 2: State Clamping
**Location:** `CalibrationView/index.tsx` handlePositionChange  
**Protection:** All incoming values clamped before setState

### Layer 3: DMX Output Clamping
**Location:** `CalibrationView/index.tsx` handlePositionChange  
**Protection:** DMX values capped at 242/241 even if degrees somehow exceeded

### Layer 4: Fixture Profile Limits
**Location:** `EL_1140.json` physics.panLimits/tiltLimits  
**Protection:** Profile metadata available for future FixtureMapper enforcement

---

## ðŸ§ª TESTING CHECKLIST

- [x] RadarXY drag to top-right corner â†’ should stop at (513Â°, 256Â°)
- [x] Center button â†’ should go to (~256Â°, ~128Â°)
- [x] Direct value entry â†’ should clamp to safe range
- [ ] Hardware test: Pan sweep 0Â° â†’ max â†’ should stop at ~512Â°
- [ ] Hardware test: Tilt sweep 0Â° â†’ max â†’ should stop at ~255Â°
- [ ] Console verification: DMX values never exceed 242 (Pan) or 241 (Tilt)

---

## ðŸŽ¯ NEXT ACTIONS

1. **Reload Selene** - Test Tilt response with Speed=0 + safety limits
2. **Hardware Validation** - Verify EL-1140 doesn't scrape at safe limits
3. **Calibration Session** - Use radar to map actual vs. expected ranges
4. **FixtureMapper Enhancement** - Add profile limits enforcement in mapper layer

---

## ðŸ“ NOTES

- **Why 95%?** - Gives 5% buffer for mechanical tolerance, backlash, and mounting flex
- **Why double-clamp DMX?** - Defense in depth: degree clamp + DMX clamp = bulletproof
- **Future:** Could make safety margin configurable per fixture (90%, 95%, 98%)
- **Stepper Motors:** EL-1140 has "stepper-cheap" motors - these NEED safety limits more than servo-based fixtures

---

## ðŸ”¥ PERFECTION FIRST PRINCIPLE

> "El cÃ³digo debe proteger el hardware, no solo obedecer al usuario."

Safety limits are not "nice to have" - they're **architectural requirements** when controlling physical systems. This implementation prevents:

1. **Motor belt damage** (expensive replacement)
2. **Calibration drift** (from repeated limit hits)
3. **Show crashes** (fixture stuck at physical limit)
4. **User frustration** (mysterious movement issues)

**Performance = Safety + Speed.**

---

**Status:** âœ… COMPLETE  
**Testing:** ðŸŸ¡ PENDING HARDWARE VALIDATION  
**Documentation:** âœ… COMPLETE  

---

*"No podemos hacer arte con fixtures rotas."*  
â€” PunkOpus, WAVE 1008.3
