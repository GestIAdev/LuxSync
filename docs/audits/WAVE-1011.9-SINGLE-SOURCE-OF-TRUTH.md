# ğŸ”¥ WAVE 1011.9: THE SINGLE SOURCE OF TRUTH

**Fecha**: 27 de Enero 2026  
**Autor**: PunkOpus  
**Status**: âœ… COMPLETADO

---

## ğŸ“‹ PROBLEMA DETECTADO

### SÃ­ntoma
Parpadeo incesante en **TODAS LAS VIBES** (Latino, Techno, Rock) despuÃ©s de conectar el FFT 4K completo al flujo en WAVE 1011.1.

Zonas mÃ¡s afectadas:
- Movers L/R (se nutren de mid)
- Back Pars (se nutren de mid)
- Front Pars menos afectados (peak hold ayuda)

### Causa RaÃ­z: RACE CONDITION

HabÃ­a **DOS FUENTES** de datos que sobrescribÃ­an `lastAudioData.bass/mid/high/energy`:

1. **`processAudioFrame()`** (lÃ­nea 1247): RecibÃ­a datos del Frontend
2. **`brain.on('audio-levels')`** (lÃ­nea 172): RecibÃ­a datos del Worker Beta

Ambas corrÃ­an en paralelo a diferentes frecuencias, sobrescribiÃ©ndose mutuamente.

```
Frame 1: Worker envÃ­a bass=0.45 â†’ lastAudioData.bass = 0.45
Frame 2: Frontend envÃ­a bass=0.52 â†’ lastAudioData.bass = 0.52  â† SOBRESCRIBE
Frame 3: Worker envÃ­a bass=0.46 â†’ lastAudioData.bass = 0.46  â† SOBRESCRIBE
Frame 4: Frontend envÃ­a bass=0.48 â†’ lastAudioData.bass = 0.48  â† SOBRESCRIBE
...
```

Resultado: Los valores oscilaban entre dos fuentes, causando parpadeo en los fixtures.

---

## ğŸ”§ SOLUCIÃ“N IMPLEMENTADA

### DecisiÃ³n ArquitectÃ³nica

**El Worker Beta (FFT 4K + AGC) es la ÃšNICA fuente autoritativa** para:
- `bass`
- `mid`
- `high` (treble)
- `energy`

### Cambios en `TitanOrchestrator.ts`

1. **`processAudioFrame()`**: Ya NO sobrescribe `bass/mid/high/energy`
   - Solo actualiza mÃ©tricas FFT extendidas si vienen (raro desde frontend)
   - Preserva los valores del Worker

2. **`brain.on('audio-levels')`**: Es la ÃšNICA fuente que actualiza las bandas base
   - Comentario claro de "AUTHORITATIVE SOURCE"
   - Log de confirmaciÃ³n: `"Worker Beta FFT 4K is THE SINGLE SOURCE OF TRUTH"`

---

## ğŸ“Š FLUJO DE DATOS CORREGIDO

```
ANTES (ROTO):
Frontend â”€â”€audioFrame()â”€â”€â”
                         â”œâ”€â”€â–º lastAudioData (RACE CONDITION) â”€â”€â–º Physics
Worker Beta â”€â”€audio-levelsâ”€â”€â”˜

AHORA (CORRECTO):
Frontend â”€â”€audioFrame()â”€â”€â–º (IGNORADO para bass/mid/high/energy)
                              â”‚
                              â–¼
Worker Beta â”€â”€audio-levelsâ”€â”€â–º lastAudioData (SINGLE SOURCE) â”€â”€â–º Physics
```

---

## âœ… VERIFICACIÃ“N

- [x] Build exitoso sin errores TypeScript
- [ ] Test manual: Latino sin parpadeo
- [ ] Test manual: Techno sin parpadeo
- [ ] Test manual: Rock sin parpadeo

---

## ğŸ“ LECCIONES APRENDIDAS

1. **Una sola fuente de verdad**: Cuando mÃºltiples fuentes alimentan el mismo dato, hay race conditions.
2. **El Worker FFT es el rey**: Tiene AGC, normalizaciÃ³n y el anÃ¡lisis espectral real.
3. **El Frontend es redundante**: Sus datos eran una copia inferior de lo que el Worker ya tenÃ­a.

---

## ğŸ¯ PRÃ“XIMOS PASOS

Con la race condition eliminada, podemos continuar calibrando RockStereoPhysics2 con datos FFT estables y confiables.
