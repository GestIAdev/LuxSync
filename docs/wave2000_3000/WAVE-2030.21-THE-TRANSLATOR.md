# WAVE 2030.21: THE TRANSLATOR ğŸ”¥
## Scaling, Color Translation & Merge Simplification

**Fecha**: 2026-02-12  
**Estado**: âœ… COMPLETADO  
**Tests**: 120/120 (57 nuevos + 63 existentes)

---

## FILOSOFÃA

> *"HephaestusRuntime formatea. TitanOrchestrator fusiona. Sin cruces, sin ambigÃ¼edad."*

El problema era claro: el TitanOrchestrator estaba escalando valores del Runtime (0-1 â†’ 0-255), convirtiendo colores (HSL â†’ RGB), y decidiendo formatos. Eso viola el principio de responsabilidad Ãºnica. El Runtime debe entregar datos **DMX-ready**. El Orchestrator debe **solo fusionar**.

---

## PIEZAS IMPLEMENTADAS

### âš’ï¸ PIEZA 1: THE SCALER (`HephaestusRuntime.ts`)

**Nuevas funciones exportadas:**

| FunciÃ³n | PropÃ³sito |
|---------|-----------|
| `hslToRgb(h, s, l)` | HSL â†’ RGB puro (0-255). Sin dependencias. |
| `scaleToDMX(paramId, rawValue)` | 0-1 â†’ 0-255 para DMX params, passthrough para engine-internal |

**CategorizaciÃ³n de parÃ¡metros:**

| CategorÃ­a | ParÃ¡metros | Scaling |
|-----------|-----------|---------|
| DMX-Scaled | intensity, strobe, white, amber, pan, tilt | `Math.round(v * 255)` |
| Float Passthrough | speed, zoom, width, direction, globalComp | Clamp 0-1 |
| Color (HSL) | color | `hslToRgb()` â†’ `{r, g, b}` 0-255 |

**`tick()` reescrito:**
- Detecta `curve.valueType === 'color'` â†’ usa `getColorValue()` â†’ `hslToRgb()` â†’ campo `rgb`
- Todos los demÃ¡s â†’ `getValue()` â†’ `scaleToDMX()` â†’ campo `value`
- Intensity modula lightness del color (no destruye hue/saturaciÃ³n)

**`HephFixtureOutput` extendido:**
```typescript
interface HephFixtureOutput {
  fixtureId: string
  zone: EffectZone | 'all'
  parameter: string
  value: number       // DMX-scaled (0-255) or float (0-1)
  rgb?: { r, g, b }   // Pre-converted color (only for 'color' param)
  source: 'hephaestus-runtime'
}
```

### âš’ï¸ PIEZA 2: MERGE SIMPLIFICATION (`TitanOrchestrator.ts`)

**ANTES (WAVE 2030.19):**
```
intensity â†’ Math.round(output.value * 255) â†’ HTP
colorHue â†’ find satOutput/lumOutput â†’ hslToRgb() â†’ LTP
strobe â†’ Math.round(output.value * 255) â†’ Additive
```

**DESPUÃ‰S (WAVE 2030.21):**
```
intensity â†’ output.value (ya es 0-255) â†’ HTP max
color â†’ output.rgb.{r,g,b} (ya es RGB) â†’ LTP directo
strobe â†’ output.value (ya es 0-255) â†’ Additive sum
```

El switch case pasÃ³ de **escalar + convertir + fusionar** a **solo fusionar**. 
Zero `Math.round()` calls. Zero `hslToRgb()` calls. Zero scaling logic.

### âš’ï¸ PIEZA 3: VISUALIZER FIX (`ClipRenderer.tsx`)

**ANTES:**
- `decorativeCurve` usaba `Math.sin()` con phase basada en `clip.id.charCodeAt(0)` 
- FAKE. DECORATIVO. ANTI-AXIOMA.

**DESPUÃ‰S:**
- `curvePath` renderiza los keyframes reales del `FXClip.keyframes[]`
- Mapea `offsetMs â†’ x`, `value (0-1) â†’ y` (invertido, 1=arriba)
- LÃ­nea sÃ³lida (no dashed) â€” es data real, no decoraciÃ³n

**TODO (WAVE 2030.22+):**
- Cargar curvas completas del `.lfx` via IPC al momento del drop
- Inyectar `hephClip` en el `FXClip` para renderizar curvas multi-parÃ¡metro

---

## ARCHIVOS MODIFICADOS

| Archivo | Cambio |
|---------|--------|
| `HephaestusRuntime.ts` | +hslToRgb, +scaleToDMX, HephFixtureOutput extend, tick() color branch |
| `TitanOrchestrator.ts` | Merge switch simplificado (zero scaling) |
| `ClipRenderer.tsx` | HephClipContent: real keyframes â†’ SVG path |
| `HephTranslator.test.ts` | **NUEVO** â€” 57 tests (hslToRgb + scaleToDMX) |

---

## TEST RESULTS

```
 âœ“ AudioBindingSerialization.test.ts     5 tests
 âœ“ HephParameterOverlay.test.ts         20 tests
 âœ“ HephTranslator.test.ts              57 tests â† NEW
 âœ“ CurveEvaluator.test.ts              38 tests

 Test Files  4 passed (4)
      Tests  120 passed (120)
   Duration  354ms
```

### Test Coverage (HephTranslator.test.ts)

- **hslToRgb**: Primary colors, achromatic, secondary colors, hue wrapping (360, 720, negative), DMX-relevant colors (amber, violet), lightness dimming
- **scaleToDMX**: All 6 DMX params Ã— 3 values (0, 0.5, 1) = 18 tests. All 5 float params Ã— 3 values = 15 tests. 8 edge case tests (clamping, rounding, unknown params)

---

## DATA FLOW (POST WAVE 2030.21)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CurveEvaluator               â”‚
â”‚  getValue() â†’ 0-1 float             â”‚
â”‚  getColorValue() â†’ HSL {h,s,l}      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      HephaestusRuntime.tick()        â”‚
â”‚                                      â”‚
â”‚  NUMERIC â†’ scaleToDMX() â†’ 0-255     â”‚
â”‚  COLOR â†’ hslToRgb() â†’ {r,g,b}      â”‚
â”‚  INTENSITY modulates lightness       â”‚
â”‚                                      â”‚
â”‚  Output: DMX-READY HephFixtureOutput â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TitanOrchestrator.processFrame()   â”‚
â”‚                                      â”‚
â”‚  ONLY MERGES. NEVER SCALES.          â”‚
â”‚  HTP for dimmer                      â”‚
â”‚  LTP for color/pan/tilt/white/amber  â”‚
â”‚  Additive for strobe                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**WAVE 2030.21: THE TRANSLATOR â€” SEALED.** âš’ï¸ğŸ”¥
