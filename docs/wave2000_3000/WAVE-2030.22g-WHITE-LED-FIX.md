# âš’ï¸ WAVE 2030.22g: WHITE LED CHANNEL RENDERING FIX

**Date**: February 12, 2026  
**Status**: âœ… COMPLETE  
**Commits**: 4 + final merge  

---

## ğŸ“‹ EXECUTIVE SUMMARY

**THE PROBLEM**: 
White LED parameters (and amber) were being sent to hardware DMX but **NOT rendering in the StageSimulator UI**. Users could see dimmer pulsing but color remained invisible.

**ROOT CAUSE ANALYSIS**:
Three separate breaking points in the data pipeline:

1. **HephaestusRuntime** âœ… Correctly scaled white to 0-255 DMX
2. **TitanOrchestrator** âœ… Correctly merged white into fixture state
3. **HAL/FixtureMapper** âœ… Correctly mapped white to DMX packets
4. **âŒ BROKEN #1**: `hal.sendStates()` never called after Hephaestus merge
5. **âŒ BROKEN #2**: `SeleneTruth.hardware.fixtures` didn't include `white` field
6. **âŒ BROKEN #3**: `calculateFixtureRenderValues()` ignored white/amber channels

**THE FIX**:
Three surgical interventions to wire white through the entire UI pipeline.

---

## ğŸ” DETAILED ROOT CAUSE CHAIN

### Problem Symptom
```
âœ… HephaestusRuntime logs: "WHITE: raw=0.993, intensity=1.000, scaled=253"
âœ… TitanOrchestrator logs: "FINAL FIXTURE: white=253, dimmer=255"
âœ… DMX packets generated with white=253
âŒ StageSimulator shows nothing
```

The **issue wasn't hardware output** - it was **UI rendering**.

### Problem Layer 1: Missing HAL Send After Hephaestus

**Location**: `TitanOrchestrator.ts` (line 585-1053)

**Symptom**: 
```
1. HAL.renderFromTarget() generates fixtureStates and SENDS to DMX
2. Titan receives states back
3. Titan applies Hephaestus overlays (white=253)
4. âŒ Titan DOESN'T send modified states back to HAL
5. HAL only ever sees the original unmodified states
```

**Why it broke**:
- Original architecture: `hal.renderFromTarget()` was the ONLY DMX send point
- New requirement: Hephaestus modifies states AFTER HAL already sent
- Result: Hephaestus changes exist only in memory, never reach DMX

**Impact**: Hardware never sees white/amber values from Hephaestus

---

### Problem Layer 2: Missing White Field in SeleneTruth Broadcast

**Location**: `TitanOrchestrator.ts` (lines 1280-1380)

**Symptom**:
```typescript
// SeleneTruth.hardware.fixtures mapping
return {
  id: realId,
  name: f.name,
  dimmer: f.dimmer / 255,
  color: { r: f.r, g: f.g, b: f.b },
  pan: f.pan / 255,
  tilt: f.tilt / 255,
  zoom: f.zoom,
  focus: f.focus,
  // âŒ NO WHITE FIELD !!!
  physicalPan: ...,
  physicalTilt: ...,
}
```

**Why it broke**:
- When Hephaestus updates `fixtureStates.white = 253`, this value exists in the array
- But when Titan maps states to broadcast `SeleneTruth.hardware.fixtures`, the `white` field is OMITTED
- StageSimulator never receives the white value to render

**Impact**: UI doesn't know white exists, so can't display it

---

### Problem Layer 3: White Ignored in Render Pipeline

**Location**: `useFixtureRender.ts` (line 46+)

**Symptom**:
```typescript
export function calculateFixtureRenderValues(truthData) {
  let color = truthData?.color || { r: 0, g: 0, b: 0 }
  let intensity = (truthData?.intensity ?? 0) * globalIntensity
  
  // Extract pan, tilt, zoom, focus, physics...
  
  // âŒ White and amber completely ignored
  // No extraction: const white = truthData?.white
  // No application: color.r += white
  
  return { color, intensity, pan, tilt, ... }
}
```

**Why it broke**:
- Function designed when only RGB was available
- Added white/amber channels later but never updated the render function
- Render data has white, but pipeline discards it before using

**Impact**: Even if white reaches the render function, it gets thrown away

---

## ğŸ”§ THE SOLUTION

### Fix #1: Wire Hephaestus States Back to HAL

**File**: `HardwareAbstraction.ts`

**Change**:
```typescript
// Added public method to HAL
public sendStates(states: FixtureState[]): void {
  this.sendToDriver(states)
}
```

**File**: `TitanOrchestrator.ts` (after line 1167)

**Change**:
```typescript
// After applying Hephaestus overlays, send modified states back to HAL
if (hephOutputs.length > 0) {
  this.hal.sendStates(fixtureStates)
}
```

**Impact**: Hardware now receives Hephaestus white/amber values âœ…

---

### Fix #2: Include White in SeleneTruth Broadcast

**File**: `TitanOrchestrator.ts` (line ~1360)

**Change**:
```typescript
// In the SeleneTruth.hardware.fixtures mapping:
return {
  id: realId,
  name: f.name,
  // ... existing fields ...
  
  // âš’ï¸ WAVE 2030.22g: Add white and amber
  white: f.white ?? 0,              // 0-255 DMX
  amber: f.amber ?? 0,              // 0-255 DMX
  
  physicalPan: ...,
}
```

**Impact**: UI now receives white/amber values in broadcast âœ…

---

### Fix #3: Apply White/Amber in Render Calculation

**File**: `useFixtureRender.ts` (line 46+)

**Change**:
```typescript
export function calculateFixtureRenderValues(truthData, ...) {
  let color = truthData?.color || { r: 0, g: 0, b: 0 }
  
  // âš’ï¸ WAVE 2030.22g: Extract and apply white/amber
  const white = truthData?.white ?? 0  // 0-255 DMX
  const amber = truthData?.amber ?? 0  // 0-255 DMX
  
  // Add white to all RGB (white LED effect)
  if (white > 0) {
    color = {
      r: Math.min(255, color.r + white),
      g: Math.min(255, color.g + white),
      b: Math.min(255, color.b + white),
    }
  }
  
  // Add amber warmth (R + partial G, no B)
  if (amber > 0) {
    color = {
      r: Math.min(255, color.r + amber),
      g: Math.min(255, color.g + Math.round(amber * 0.5)),
      b: color.b,
    }
  }
  
  return { color, intensity, pan, tilt, ... }
}
```

**Impact**: StageSimulator now renders white/amber on screen âœ…

---

## ğŸ”¬ DATA FLOW VERIFICATION

### Before Fix:
```
HephaestusRuntime
  â†“ white=253 âœ…
TitanOrchestrator
  â†“ white=253 applied âœ…
  â†“ hal.sendStates() âŒ NOT CALLED
HAL
  â†“ old render from line 585 (no white)
FixtureMapper
  â†“ maps white to DMX âœ…
DMX Hardware
  â†“ white=253 sent âœ…
  â†“ but UI never updated âŒ
  
  
StageSimulator
  â†“ broadcast has no white field âŒ
  â†“ render function ignores white âŒ
  â†“ Blanco NO visible in UI âŒ
```

### After Fix:
```
HephaestusRuntime
  â†“ white=253 âœ…
TitanOrchestrator
  â†“ white=253 applied âœ…
  â†“ hal.sendStates(fixtureStates) âœ… SENDS MODIFIED STATES
HAL
  â†“ sendStates() â†’ sendToDriver()
FixtureMapper
  â†“ maps white to DMX âœ…
DMX Hardware
  â†“ white=253 sent âœ…
  
TitanOrchestrator (broadcast)
  â†“ white: 253 included in SeleneTruth âœ…
StageSimulator
  â†“ calculateFixtureRenderValues()
  â†“ extracts white âœ…
  â†“ adds white to RGB âœ…
  â†“ returns { color: {r:255, g:255, b:255}, ... } âœ…
Canvas Renderer
  â†“ Blanco VISIBLE in UI âœ…
```

---

## ğŸ“Š FILES MODIFIED

| File | Lines | Change | Impact |
|------|-------|--------|--------|
| `HardwareAbstraction.ts` | 1056-1068 | Add public `sendStates()` method | HAL can send at any time |
| `TitanOrchestrator.ts` | 1175-1183 | Call `hal.sendStates()` after Hephaestus merge | Hardware gets updated values |
| `TitanOrchestrator.ts` | 1360-1365 | Add `white` and `amber` to broadcast | UI receives LED values |
| `useFixtureRender.ts` | 60-88 | Extract and apply white/amber in color calculation | StageSimulator renders LEDs |
| `HAL.ts` (sendToDriver) | 1069-1078 | Add debug log for white values | Debugging support |

---

## âœ… VALIDATION CHECKLIST

- [x] HephaestusRuntime scaling: `raw=0.993 â†’ scaled=253` âœ…
- [x] TitanOrchestrator merge: `white=253` applied to fixtures âœ…
- [x] hal.sendStates() called after merge âœ…
- [x] SeleneTruth broadcast includes white field âœ…
- [x] calculateFixtureRenderValues extracts white âœ…
- [x] StageSimulator renders white LED as brighter color âœ…
- [x] strobetest.lfx displays white flash in UI âœ…

---

## ğŸ“ KEY LEARNINGS

### Architectural:
1. **Data flows in STAGES**: Runtime â†’ Orchestrator â†’ HAL â†’ UI
2. **Each stage must be aware of new parameters** (white/amber weren't in broadcast)
3. **Post-processing changes require post-processing output** (Hephaestus â†’ hal.sendStates)

### Implementation:
1. **Electron color values in DMX are 0-255**, but UI expects 0-255 RGB too
2. **White LED = simultaneous R+G+B** (additive mixing)
3. **Amber LED = R + partial G** (warm color simulation)

### Debugging:
1. **Follow the data**: Track values from source â†’ each layer â†’ output
2. **Silent failures are worst**: white was being sent to hardware but UI never updated
3. **Multiple independent bugs can chain**: Each "fix" revealed the next layer

---

## ğŸš€ FUTURE CONSIDERATIONS

### For Other LED Channels:
- **UV (ultraviolet)**: Add as separate channel, minimal RGB impact
- **RGB Fine Control**: Could add R/G/B fine channels (14-bit DMX)
- **Color Temperature**: White + Amber blend for tunable white fixtures

### For Hephaestus:
- Consider caching HAL reference to avoid repeated param lookups
- Could batch multiple `sendStates()` calls per frame if needed
- Monitor DMX packet count with many simultaneous clips

---

## ğŸ“Œ SUMMARY

**Problem**: Three independent breaking points prevented white LED rendering  
**Root Cause**: Missing integration between Hephaestus â†’ HAL â†’ UI broadcast â†’ renderer  
**Solution**: Wire white/amber through all three pipeline stages  
**Result**: âœ… **BLANCO VISIBLE** in StageSimulator and DMX hardware  

---

**Commit**: `f93f263` (WAVE 2030.22f audio fix) + follow-up fixes  
**Testing**: strobetest.lfx with white curve shows full brightness white flash  
**Status**: Production ready âœ…
