/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ğŸ« DEEP BREATH - RESPIRACIÃ“N PROFUNDA
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * ğŸ”¬ WAVE 938: ATMOSPHERIC ARSENAL (Radwulf)
 * 
 * FILOSOFÃA:
 * Darle pulmones a la pista de baile. OrgÃ¡nico y biomecÃ¡nico.
 * RespiraciÃ³n lenta y profunda (4 compases completos).
 * 
 * COMPORTAMIENTO:
 * - MixBus: 'htp' (ADITIVO - respira con la fÃ­sica)
 * - SincronizaciÃ³n: 4 compases (16 beats) - MUY LENTO
 * - CompÃ¡s 1-2 (Inhalar): 0% â†’ 60% + Movers se abren (Tilt Up + Pan Out)
 * - CompÃ¡s 3-4 (Exhalar): 60% â†’ 0% + Movers se cierran (Tilt Down + Pan In)
 * - Usa sine wave basado en tiempo del sistema (continuo, no golpes)
 * 
 * COLORES:
 * - DEEP BLUE (#0033aa) o UV PURPLE (#6600ff)
 * - TransiciÃ³n suave durante la respiraciÃ³n
 * 
 * ZONAS:
 * - Perfecto para valley, breakdown, silence
 * - Ideal para momentos tensos antes del drop
 * 
 * @module core/effects/library/techno/DeepBreath
 * @version WAVE 938 - ATMOSPHERIC ARSENAL (Radwulf)
 */

import { BaseEffect } from '../../BaseEffect'
import { 
  EffectTriggerConfig, 
  EffectFrameOutput, 
  EffectCategory
} from '../../types'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface DeepBreathConfig {
  /** DuraciÃ³n de una respiraciÃ³n completa (inhale + exhale) en ms */
  breathCycleMs: number
  
  /** NÃºmero de ciclos de respiraciÃ³n */
  breathCount: number
  
  /** Intensidad mÃ¡xima durante inhale peak */
  peakIntensity: number
  
  /** BPM-synced (4 compases = 16 beats) */
  bpmSync: boolean
  
  /** Beats por ciclo de respiraciÃ³n (si bpmSync=true) */
  beatsPerCycle: number
  
  /** Amplitud de movimiento de movers (grados) */
  movementAmplitude: number
}

const DEFAULT_CONFIG: DeepBreathConfig = {
  breathCycleMs: 8000,       // 8 segundos por ciclo (4 compases a 120 BPM)
  breathCount: 2,            // 2 respiraciones completas
  peakIntensity: 0.6,        // 60% mÃ¡ximo
  bpmSync: true,
  beatsPerCycle: 16,         // 4 compases = 16 beats
  movementAmplitude: 60,     // Â±60Â° de movimiento
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEEP BREATH EFFECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export class DeepBreath extends BaseEffect {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ILightEffect properties
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  readonly effectType = 'deep_breath'
  readonly name = 'Deep Breath'
  readonly category: EffectCategory = 'physical'
  readonly priority = 45  // Media-baja - efecto atmosfÃ©rico intenso
  readonly mixBus = 'htp' as const  // ADITIVO - respira con fÃ­sica
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Internal state
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  private config: DeepBreathConfig
  private totalDurationMs: number
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Constructor
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  constructor(config?: Partial<DeepBreathConfig>) {
    super('deep_breath')
    this.config = { ...DEFAULT_CONFIG, ...config }
    this.totalDurationMs = this.config.breathCycleMs * this.config.breathCount
  }
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ILightEffect implementation
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  trigger(triggerConfig: EffectTriggerConfig): void {
    super.trigger(triggerConfig)
    
    console.log(`[DeepBreath ğŸ«] TRIGGERED! Cycles=${this.config.breathCount} CycleMs=${this.config.breathCycleMs}`)
  }

  update(deltaMs: number): void {
    if (this.phase === 'idle' || this.phase === 'finished') return
    
    this.elapsedMs += deltaMs
    
    // Check si terminÃ³
    if (this.elapsedMs >= this.totalDurationMs) {
      this.phase = 'finished'
      console.log(`[DeepBreath ğŸ«] FINISHED (${this.config.breathCount} cycles)`)
    }
  }
  
  /**
   * ğŸ“¤ GET OUTPUT - Devuelve el output del frame actual
   * ğŸ« WAVE 938: DEEP BREATH - RespiraciÃ³n orgÃ¡nica
   */
  getOutput(): EffectFrameOutput | null {
    if (this.phase === 'idle' || this.phase === 'finished') return null

    const progress = this.elapsedMs / this.totalDurationMs

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SINE WAVE: RespiraciÃ³n continua
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const cycleProgress = (this.elapsedMs % this.config.breathCycleMs) / this.config.breathCycleMs
    const sinePhase = cycleProgress * 2 * Math.PI
    
    // Sine wave: 0 â†’ 1 â†’ 0 (inhale â†’ peak â†’ exhale)
    const breathIntensity = (Math.sin(sinePhase - Math.PI / 2) + 1) / 2
    const dimmer = breathIntensity * this.config.peakIntensity

    // Color: transiciÃ³n DEEP BLUE â†” UV PURPLE durante respiraciÃ³n
    const hue = 220 + breathIntensity * 60 // 220 (blue) â†’ 280 (purple)
    const color = { h: hue, s: 100, l: 40 }

    const output: EffectFrameOutput = {
      effectId: this.id,
      category: this.category,
      phase: this.phase,
      progress,
      zones: ['front', 'pars', 'back', 'movers'],
      intensity: this.triggerIntensity * breathIntensity,
      zoneOverrides: {},
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PARS: Dimmer sincronizado con respiraciÃ³n
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const parZones = ['front', 'pars', 'back'] as const
    
    parZones.forEach(zone => {
      output.zoneOverrides![zone] = {
        dimmer,
        color,
        blendMode: 'max' as const,
      }
    })

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOVERS: Movimiento orgÃ¡nico (abrir/cerrar)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Tilt: -30Â° (down) â†’ +30Â° (up) â†’ -30Â° (down)
    const tilt = -30 + breathIntensity * 60
    
    // Pan: spread out durante inhale (Â±60Â°)
    // TODO: Para hacer pan left/right necesitamos conocer el Ã­ndice del fixture
    // Por ahora usamos 0Â° (centro)
    const pan = 0

    output.zoneOverrides!['movers'] = {
      dimmer,
      color,
      blendMode: 'max' as const,
      movement: {
        pan,
        tilt,
      },
    }

    return output
  }
  
  isFinished(): boolean {
    return this.phase === 'finished'
  }
  
  abort(): void {
    this.phase = 'finished'
    console.log(`[DeepBreath ğŸ«] Aborted`)
  }
}
