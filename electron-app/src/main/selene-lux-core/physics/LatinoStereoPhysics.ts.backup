/**
 * ðŸŒ´ WAVE 165: LATINO STEREO PHYSICS ("Clean Honey & Heavy Trigger")
 * ============================================================================
 * LÃ³gica afinada para Cumbia y Reggaeton.
 * 
 * CAMBIOS WAVE 165:
 * 1. ðŸ§¹ LIMPIEZA: Eliminado cÃ³digo muerto y comentarios legacy.
 * 2. ðŸ¯ COLOR MIEL REAL: L=45% (antes 50%). H=38 (Ãmbar).
 * 3. ðŸ”« HEAVY TRIGGER: Solo dispara Solar Flare si Bass > 0.80 y hay impacto.
 * 
 * FILOSOFÃA:
 * - Si es CUMBIA: NeÃ³n y Movimiento (Nunca blanco).
 * - Si es REGGAETON/SALSA: Golpes de Miel (Solar Flare) solo en impactos masivos.
 * ============================================================================
 */

// Type definitions
export interface RGB { r: number; g: number; b: number; }
export interface HSL { h: number; s: number; l: number; }

// Interfaces
export interface LatinoPalette { primary: RGB; secondary: RGB; ambient: RGB; accent: RGB; }
export interface LatinoAudioMetrics { normalizedBass: number; normalizedEnergy: number; normalizedHigh?: number; previousEnergy?: number; deltaTime?: number; }
export type LatinoSubGenre = 'cumbia' | 'reggaeton' | 'salsa' | 'generic';

export interface LatinoPhysicsResult {
  palette: LatinoPalette;
  isSolarFlare: boolean;
  isMachineGunBlackout: boolean;
  dimmerOverride: number | null;
  forceMovement: boolean;
  subGenre: LatinoSubGenre;
  debugInfo: any;
}

/**
 * LatinoStereoPhysics - MÃ³dulo de Reactividad para Fiesta Latina
 * 
 * Esta clase encapsula la lÃ³gica de detecciÃ³n de efectos tropicales:
 * - SOLAR FLARE: Destello dorado en kicks fuertes
 * - MACHINE GUN: Blackout instantÃ¡neo en cortes de reggaeton
 */
export class LatinoStereoPhysics {
  // =========================================================================
  // ðŸ”’ CONFIGURACIÃ“N INMUTABLE (Calibrada para Reggaeton/Cumbia/Salsa)
  // =========================================================================
  
  /**
   * ðŸ”§ WAVE 163: GOLDEN DISCIPLINE - GATILLO CARO
   * Umbral de disparo para SOLAR FLARE (Bombo fuerte).
   * Cuando el bass supera este valor Y hay delta positivo, disparamos destello dorado.
   * @calibration Subido a 0.75 para que solo GOLPES MAESTROS activen el efecto
   * El "chunta-chunta" normal se queda en color, solo impactos Ã©picos = oro
   */
  private static readonly KICK_THRESHOLD = 0.75;  // ï¿½ï¸ WAVE 163: Subido de 0.60
  
  /**
   * ðŸŒ¿ WAVE 161: Delta Trigger - Requiere SUBIDA brusca de bass
   * Solo dispara Solar Flare si el bass SUBIÃ“ este porcentaje vs frame anterior
   * Subido a 0.10 para requerir impactos mÃ¡s claros
   */
  private static readonly BASS_DELTA_THRESHOLD = 0.10;  // ðŸŒ¿ WAVE 161: Subido de 0.05
  
  /**
   * Incremento de luminosidad para Solar Flare.
   * El accent sube a 95% L en el flare.
   */
  private static readonly FLARE_LIGHTNESS = 95;
  
  /**
   * ReducciÃ³n de saturaciÃ³n para Solar Flare.
   * Para que parezca "luz blanca-dorada" reducimos saturaciÃ³n.
   */
  private static readonly FLARE_SATURATION_REDUCTION = 10;
  
  /**
   * Umbral de caÃ­da de energÃ­a para detectar "Negative Drop".
   * Si la energÃ­a cae mÃ¡s de este porcentaje, es un corte.
   * ðŸ”§ WAVE 155.5: Bajado de 0.6 a 0.4 para pillar silencios de cumbia
   */
  private static readonly NEGATIVE_DROP_THRESHOLD = 0.4;  // 40% de caÃ­da
  
  /**
   * Ventana de tiempo mÃ¡xima para detectar Negative Drop (ms).
   * El corte debe ser RÃPIDO para ser dramÃ¡tico.
   */
  private static readonly NEGATIVE_DROP_WINDOW_MS = 100;
  
  /**
   * DuraciÃ³n del blackout en frames (aproximado).
   * El reggaeton usa cortes muy cortos (~2-4 frames @ 60fps).
   */
  private static readonly BLACKOUT_FRAMES = 3;
  
  /**
   * ðŸŒž WAVE 163: ORO PROFUNDO - Miel Azteca
   * 
   * HISTORIA DE EVOLUCIÃ“N:
   * - ANTES: HSL(40, 10%, 95%) â†’ Blanco sucio sin personalidad
   * - WAVE 152: HSL(45, 100%, 80%) â†’ Demasiado brillante, parece blanco
   * - WAVE 162.5: HSL(40, 100%, 65%) â†’ Mejor, pero aÃºn blanquea
   * - WAVE 163: HSL(42, 100%, 50%) â†’ ORO PURO/MIEL, IMPOSIBLE ver blanco
   * 
   * Con L=50% garantizamos color MIEL/ORO incluso con dimmer al 100%.
   * Es como la diferencia entre una bombilla halÃ³gena (blanca) y una vela (dorada).
   */
  private static readonly SOLAR_FLARE_COLOR: HSL = {
    h: 42,    // Oro cÃ¡lido (entre amarillo y naranja)
    s: 100,   // SaturaciÃ³n TOTAL
    l: 50,    // ðŸ›ï¸ WAVE 163: Bajado a 50% - Oro Puro, nunca blanco
  };

  // =========================================================================
  // ðŸŽµ WAVE 152.5: CONFIGURACIÃ“N DE SUBGÃ‰NEROS
  // =========================================================================
  
  /**
   * BPM para detecciÃ³n de subgÃ©neros.
   * CUMBIA: > 90 BPM, sÃ­ncopa caracterÃ­stica
   * REGGAETON: 85-100 BPM, dembow constante
   * SALSA: 140-180 BPM, clave compleja
   */
  private static readonly BPM_CUMBIA_MIN = 85;
  private static readonly BPM_REGGAETON_MAX = 100;
  private static readonly BPM_SALSA_MIN = 130;
  
  /**
   * ðŸŒˆ NEON INJECTION COLORS (Cumbia Anti-Palidez)
   * Para romper monotonÃ­a en Cumbia cuando no hay Solar Flare
   * ðŸ”¥ WAVE 156: AÃ±adido Naranja NeÃ³n para PRIMARY
   */
  private static readonly NEON_MAGENTA: HSL = { h: 300, s: 100, l: 65 };
  private static readonly NEON_CYAN: HSL = { h: 180, s: 100, l: 60 };
  private static readonly NEON_LIME: HSL = { h: 120, s: 100, l: 55 };
  private static readonly NEON_ORANGE: HSL = { h: 30, s: 100, l: 55 };  // ðŸ”¥ Naranja NeÃ³n
  private static readonly NEON_YELLOW: HSL = { h: 55, s: 100, l: 55 };  // ðŸ’› Amarillo NeÃ³n

  /**
   * ðŸŽ¯ WAVE 161.5: NEON PUMP COOLDOWN
   * MÃ­nimo de frames entre cambios de color para evitar epilepsia.
   * @ 60fps: 8 frames = ~133ms entre cambios
   */
  private static readonly NEON_PUMP_COOLDOWN_FRAMES = 8;

  // =========================================================================
  // ðŸ“Š ESTADO INTERNO
  // =========================================================================
  
  /** Contador de frames en blackout (para Machine Gun) */
  private blackoutFramesRemaining = 0;
  
  /** Ãšltima energÃ­a conocida (para detectar caÃ­das) */
  private lastEnergy = 0;
  
  /** Timestamp del Ãºltimo frame */
  private lastFrameTime = Date.now();
  
  /** ðŸ”§ WAVE 152.5: Contador de beats para Neon Injection */
  private beatCounter = 0;
  
  /** ðŸ”§ WAVE 152.5: Ãšltimo BPM detectado */
  private lastBpm = 0;
  
  /** ðŸŒ¿ WAVE 158: Ãšltimo bass conocido (para Delta Trigger) */
  private lastBass = 0;
  
  /** ðŸŽ¯ WAVE 161.5: Frames desde el Ãºltimo cambio de NEON PUMP */
  private framesSinceNeonChange = 0;
  
  /** ðŸŽ¯ WAVE 161.5: Ãšltimo Ã­ndice de color usado en NEON PUMP */
  private lastNeonColorIndex = 0;
  
  // =========================================================================
  // ðŸ”§ MÃ‰TODOS PÃšBLICOS
  // =========================================================================
  
  /**
   * Aplica la fÃ­sica Latino a una paleta de colores.
   * 
   * ðŸ”§ WAVE 152.5: Ahora acepta BPM para detecciÃ³n de subgÃ©nero
   * 
   * @param palette - Paleta de colores actual (RGB)
   * @param metrics - MÃ©tricas de audio del frame actual
   * @param bpm - BPM detectado (opcional, para subgÃ©nero)
   * @returns Paleta modificada con efectos aplicados
   */
  public apply(
    palette: LatinoPalette,
    metrics: LatinoAudioMetrics,
    bpm?: number
  ): LatinoPhysicsResult {
    const now = Date.now();
    const deltaTime = metrics.deltaTime ?? (now - this.lastFrameTime);
    this.lastFrameTime = now;
    
    const previousEnergy = metrics.previousEnergy ?? this.lastEnergy;
    const currentEnergy = metrics.normalizedEnergy;
    const detectedBpm = bpm ?? this.lastBpm;
    
    if (bpm) this.lastBpm = bpm;
    
    // Calcular delta de energÃ­a
    const energyDelta = previousEnergy - currentEnergy;
    
    // ðŸŽµ WAVE 152.5: Detectar subgÃ©nero
    const subGenre = this.detectSubGenre(detectedBpm, metrics);
    
    // Crear copia de la paleta para modificar
    const resultPalette: LatinoPalette = {
      primary: { ...palette.primary },
      secondary: { ...palette.secondary },
      ambient: { ...palette.ambient },
      accent: { ...palette.accent },
    };
    
    // Inicializar flags
    let isSolarFlare = false;
    let isMachineGunBlackout = false;
    let dimmerOverride: number | null = null;
    let flareIntensity = 0;
    let neonInjected = false;
    let forceMovement = false;
    
    // =====================================================================
    // 1ï¸âƒ£ MACHINE GUN DETECTION (Negative Drop â†’ Blackout)
    // =====================================================================
    // Detectar caÃ­da brusca de energÃ­a (tÃ­pico corte de reggaeton)
    // ðŸ”§ WAVE 152.5: En CUMBIA desactivamos Machine Gun (son mÃ¡s suaves)
    const isNegativeDrop = subGenre !== 'cumbia' && (
      energyDelta >= LatinoStereoPhysics.NEGATIVE_DROP_THRESHOLD &&
      deltaTime <= LatinoStereoPhysics.NEGATIVE_DROP_WINDOW_MS &&
      previousEnergy > 0.6  // Solo si venÃ­amos de energÃ­a alta
    );
    
    if (isNegativeDrop) {
      // Â¡METRALLETA! Iniciar blackout
      this.blackoutFramesRemaining = LatinoStereoPhysics.BLACKOUT_FRAMES;
    }
    
    // Si estamos en blackout, aplicar dimmer = 0
    if (this.blackoutFramesRemaining > 0) {
      isMachineGunBlackout = true;
      dimmerOverride = 0;  // BLACKOUT TOTAL
      this.blackoutFramesRemaining--;
    }
    
    // =====================================================================
    // 2ï¸âƒ£ WAVE 156: CUMBIA MODE AGRESIVO (Rainbow RKT)
    // =====================================================================
    // ðŸš« PROHIBIDO EL SOL EN LA CUMBIA - El bajo saturado activa el flare constantemente
    // En cambio, inyectamos NEONES en ACCENT y PRIMARY para fiesta multicolor
    if (subGenre === 'cumbia' && !isMachineGunBlackout) {
      // ðŸ”¥ KILL SWITCH: isSolarFlare SIEMPRE false en Cumbia
      isSolarFlare = false;
      
      const bassPulse = metrics.normalizedBass;
      
      // Cada beat fuerte (bass > 0.4 - mÃ¡s sensible) rotamos colores
      if (bassPulse > 0.4) {
        this.beatCounter++;
        neonInjected = true;
        
        // ðŸŽ¨ ACCENT: Rotar entre Magenta â†’ Cyan â†’ Lime (Back PARs)
        const accentColors = [
          LatinoStereoPhysics.NEON_MAGENTA,
          LatinoStereoPhysics.NEON_CYAN,
          LatinoStereoPhysics.NEON_LIME,
        ];
        const accentIndex = this.beatCounter % 3;
        resultPalette.accent = this.hslToRgb(accentColors[accentIndex]);
        
        // ðŸ”¥ WAVE 156: PRIMARY tambiÃ©n rota (Front PARs) - cada 4 beats
        // Usamos colores complementarios para contraste
        const primaryColors = [
          LatinoStereoPhysics.NEON_CYAN,     // Complemento de Magenta
          LatinoStereoPhysics.NEON_ORANGE,   // CÃ¡lido
          LatinoStereoPhysics.NEON_MAGENTA,  // Complemento de Cyan
          LatinoStereoPhysics.NEON_LIME,     // Fresco
        ];
        const primaryIndex = Math.floor(this.beatCounter / 4) % 4;
        resultPalette.primary = this.hslToRgb(primaryColors[primaryIndex]);
        
        // Secondary tambiÃ©n participa (mÃ¡s sutil)
        const secondaryIndex = (this.beatCounter + 1) % 3;
        resultPalette.secondary = this.hslToRgb(accentColors[secondaryIndex]);
      }
      
      // ðŸ”§ Cumbia = movimiento continuo (baile constante)
      forceMovement = true;
    }
    
    // =====================================================================
    // 3ï¸âƒ£ SOLAR FLARE DETECTION (Kick fuerte â†’ Destello dorado)
    // ðŸŒ¿ WAVE 158: DELTA TRIGGER - Requiere SUBIDA de bass, no solo nivel alto
    // =====================================================================
    // Solo para REGGAETON y SALSA, no CUMBIA
    if (subGenre !== 'cumbia' && !isMachineGunBlackout) {
      const bassPulse = metrics.normalizedBass;
      const bassDelta = bassPulse - this.lastBass;  // ðŸŒ¿ WAVE 158: Delta vs frame anterior
      
      // ðŸŒ¿ WAVE 158: DOBLE CONDICIÃ“N - Bass alto + Delta positivo
      // Esto evita blancos constantes cuando hay bass alto sostenido
      const isKickMoment = bassPulse > LatinoStereoPhysics.KICK_THRESHOLD &&
                           bassDelta > LatinoStereoPhysics.BASS_DELTA_THRESHOLD;
      
      if (isKickMoment) {
        isSolarFlare = true;
        flareIntensity = (bassPulse - LatinoStereoPhysics.KICK_THRESHOLD) / 
                         (1 - LatinoStereoPhysics.KICK_THRESHOLD);
        
        // Aplicar Solar Flare al accent (Back PARs)
        // El accent se convierte en un destello blanco-dorado
        resultPalette.accent = this.hslToRgb(LatinoStereoPhysics.SOLAR_FLARE_COLOR);
        
        // TambiÃ©n aumentar ligeramente el brillo del primary
        // (efecto de "iluminaciÃ³n general" del escenario)
        resultPalette.primary = this.boostBrightness(
          resultPalette.primary,
          Math.min(flareIntensity * 20, 15)  // Max +15% brillo
        );
      }
      
      // ðŸŒ¿ WAVE 158: Guardar bass actual para prÃ³ximo frame
      this.lastBass = bassPulse;
      
      // =====================================================================
      // ðŸŒˆ WAVE 162: NEON PUMP DESACTIVADO
      // =====================================================================
      // El NEON PUMP era demasiado agresivo - inyectaba colores neÃ³n 
      // directamente sin respetar la paleta de Selene.
      // 
      // NUEVO ENFOQUE: El ACCENT usa el color quaternary de la paleta
      // (calculado por SeleneColorEngine con accentBehavior: 'quaternary')
      // Esto da colores variados pero INTEGRADOS con el resto del escenario.
      //
      // NEON PUMP solo se reactiva en DROPS EXTREMOS (bassPulse > 0.9)
      this.framesSinceNeonChange++;
      
      if (!isSolarFlare && bassPulse > 0.9) {
        // Solo en peaks extremos: inyectar neÃ³n para impacto
        neonInjected = true;
        
        if (this.framesSinceNeonChange >= LatinoStereoPhysics.NEON_PUMP_COOLDOWN_FRAMES) {
          this.beatCounter++;
          this.lastNeonColorIndex = this.beatCounter % 4;
          this.framesSinceNeonChange = 0;
        }
        
        const neonColors = [
          LatinoStereoPhysics.NEON_MAGENTA,
          LatinoStereoPhysics.NEON_ORANGE,  // MÃ¡s cÃ¡lidos para Latino
          LatinoStereoPhysics.NEON_YELLOW,
          LatinoStereoPhysics.NEON_LIME,
        ];
        const neonColor = neonColors[this.lastNeonColorIndex];
        resultPalette.accent = this.hslToRgb(neonColor);
      }
      // Si bassPulse <= 0.9, el accent mantiene el color de la paleta original
    }
    
    // =====================================================================
    // 4ï¸âƒ£ SALSA MODE: Movimiento perpetuo
    // =====================================================================
    if (subGenre === 'salsa') {
      forceMovement = true;  // Salsa NUNCA para de moverse
    }
    
    // =====================================================================
    // 5ï¸âƒ£ WAVE 155: GENERIC FALLBACK â†’ NEON INJECTION
    // =====================================================================
    // Si caemos en generic, mejor neÃ³n que flash blanco aburrido
    if (subGenre === 'generic' && !isMachineGunBlackout) {
      const bassPulse = metrics.normalizedBass;
      
      // En generic, inyectamos neÃ³n igual que en Cumbia
      if (bassPulse > 0.5) {
        this.beatCounter++;
        neonInjected = true;
        
        // Rotar entre Magenta â†’ Cyan â†’ Lime â†’ repeat
        const neonColors = [
          LatinoStereoPhysics.NEON_MAGENTA,
          LatinoStereoPhysics.NEON_CYAN,
          LatinoStereoPhysics.NEON_LIME,
        ];
        const colorIndex = this.beatCounter % 3;
        resultPalette.accent = this.hslToRgb(neonColors[colorIndex]);
        resultPalette.primary = this.boostBrightness(resultPalette.primary, 8);
      }
      
      forceMovement = true;  // Ante la duda, MUÃ‰VETE!
    }
    
    // Actualizar estado para el prÃ³ximo frame
    this.lastEnergy = currentEnergy;
    
    return {
      palette: resultPalette,
      isSolarFlare,
      isMachineGunBlackout,
      dimmerOverride,
      forceMovement,
      subGenre,
      debugInfo: {
        bassPulse: metrics.normalizedBass,
        energyDelta,
        isNegativeDrop,
        flareIntensity,
        detectedBpm,
        neonInjected,
      },
    };
  }
  
  /**
   * ðŸŽµ WAVE 157.1: LA DICTADURA SIMPLIFICADA
   * 
   * CATCH-ALL TOTAL - Ante la duda, ES CUMBIA:
   * - SALSA: BPM > 130 + High > Bass (agudos dominan)
   * - REGGAETON: BPM <= 90 (lento)
   * - CUMBIA: TODO LO DEMÃS 90-170 BPM (ignoramos nivel de bajo)
   */
  private detectSubGenre(bpm: number, metrics: LatinoAudioMetrics): LatinoSubGenre {
    const normalizedHigh = metrics.normalizedHigh ?? 0;
    const normalizedBass = metrics.normalizedBass;
    
    // ðŸŽº Salsa: RÃ¡pido + agudos dominantes
    if (bpm > 130 && normalizedHigh > normalizedBass) {
      return 'salsa';
    }
    
    // ðŸ”Š Reggaeton: Lento (<=90 BPM)
    if (bpm <= 90) {
      return 'reggaeton';
    }
    
    // ðŸŒ´ WAVE 157: CUMBIA = CATCH-ALL (90-170 BPM)
    // Si tiene ritmo latino â†’ ES CUMBIA (ignoramos el bajo saturado)
    if (bpm >= 90 && bpm <= 170) {
      return 'cumbia';
    }
    
    return 'generic';
  }
  
  /**
   * Reinicia el estado interno (para nueva canciÃ³n/escena)
   */
  public reset(): void {
    this.blackoutFramesRemaining = 0;
    this.lastEnergy = 0;
    this.lastFrameTime = Date.now();
    this.beatCounter = 0;
    this.lastBpm = 0;
  }
  
  // =========================================================================
  // ðŸ”§ MÃ‰TODOS PRIVADOS (Utilidades de Color)
  // =========================================================================
  
  /**
   * Convierte HSL a RGB
   */
  private hslToRgb(hsl: HSL): RGB {
    const h = hsl.h / 360;
    const s = hsl.s / 100;
    const l = hsl.l / 100;
    
    let r: number, g: number, b: number;
    
    if (s === 0) {
      r = g = b = l;
    } else {
      const hue2rgb = (p: number, q: number, t: number): number => {
        if (t < 0) t += 1;
        if (t > 1) t -= 1;
        if (t < 1/6) return p + (q - p) * 6 * t;
        if (t < 1/2) return q;
        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
        return p;
      };
      
      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      
      r = hue2rgb(p, q, h + 1/3);
      g = hue2rgb(p, q, h);
      b = hue2rgb(p, q, h - 1/3);
    }
    
    return {
      r: Math.round(r * 255),
      g: Math.round(g * 255),
      b: Math.round(b * 255),
    };
  }
  
  /**
   * Aumenta el brillo de un color RGB
   * @param rgb - Color original
   * @param percent - Porcentaje de aumento (0-100)
   */
  private boostBrightness(rgb: RGB, percent: number): RGB {
    const factor = 1 + (percent / 100);
    return {
      r: Math.min(255, Math.round(rgb.r * factor)),
      g: Math.min(255, Math.round(rgb.g * factor)),
      b: Math.min(255, Math.round(rgb.b * factor)),
    };
  }
}

// Export default para compatibilidad
export default LatinoStereoPhysics;
